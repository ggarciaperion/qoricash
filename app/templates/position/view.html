{% extends "base.html" %}

{% block title %}Posición - QoriCash Trading{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-4">
            <h2><i class="bi bi-graph-up-arrow"></i> Posición</h2>
            <p class="text-muted" id="subtituloFecha">Resumen de operaciones del día</p>
        </div>
        <div class="col-md-8 text-end">
            <!-- Selector de fecha -->
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setFechaHoy()">Hoy</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setFechaAyer()">Ayer</button>
                <input type="date" id="fechaSelector" class="form-control form-control-sm d-inline-block" style="width: 160px;">
            </div>

            <!-- Botón exportar -->
            <button class="btn btn-sm btn-success me-2" onclick="exportarExcel()">
                <i class="bi bi-file-earmark-excel"></i> Exportar
            </button>

            <!-- Botón actualizar -->
            <button class="btn btn-sm btn-outline-primary" onclick="refreshPosition()">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
            </button>
        </div>
    </div>

    <!-- Alerta de Desbalance Crítico -->
    <div id="alertaDesbalance" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>¡ALERTA DE DESBALANCE!</strong>
        <span id="mensajeDesbalance"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Sección Posición -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-calculator"></i> Resumen del Día</h5>
                    <div>
                        <span class="badge bg-info me-2" id="badgeTotalOps">0 operaciones</span>
                        <span class="badge bg-secondary" id="badgeTC">TC Prom: 0.0000</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="posicionContainer">
                        <!-- Se llenará con JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Reconciliación de Saldos Bancarios -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h5 class="mb-0"><i class="bi bi-bank"></i> Saldos Bancarios</h5>
                            <small id="subtituloFechaSaldos" class="text-white-50">Información del día</small>
                        </div>
                        <div class="col-md-8 text-end">
                            <!-- Filtro de fecha para Saldos Bancarios -->
                            <div class="btn-group me-2" role="group">
                                <button type="button" class="btn btn-sm btn-light" onclick="setFechaSaldosHoy()">Hoy</button>
                                <button type="button" class="btn btn-sm btn-light" onclick="setFechaSaldosAyer()">Ayer</button>
                                <input type="date" id="fechaSaldosSelector" class="form-control form-control-sm d-inline-block" style="width: 160px;">
                            </div>

                            <button class="btn btn-sm btn-light me-2" onclick="refreshReconciliation()">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar
                            </button>
                            <button class="btn btn-sm btn-success" onclick="openAddBankModal()">
                                <i class="bi bi-plus-circle"></i> Agregar Banco
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Alerta de Descuadre Crítico -->
                    <div id="alertaDescuadre" class="alert alert-danger d-none" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>¡DESCUADRE DETECTADO!</strong>
                        <span id="mensajeDescuadre"></span>
                    </div>

                    <!-- Resumen de Movimientos del Día -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="mb-3"><i class="bi bi-graph-up"></i> Resumen de Movimientos (Solo Operaciones Completadas)</h6>
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">USD Entradas (Ventas)</small>
                                            <h5 class="text-success mb-0" id="summaryUsdIn">$0.00</h5>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">USD Salidas (Compras)</small>
                                            <h5 class="text-danger mb-0" id="summaryUsdOut">$0.00</h5>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">PEN Entradas (Compras)</small>
                                            <h5 class="text-success mb-0" id="summaryPenIn">S/0.00</h5>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">PEN Salidas (Ventas)</small>
                                            <h5 class="text-danger mb-0" id="summaryPenOut">S/0.00</h5>
                                        </div>
                                    </div>
                                    <hr class="my-2">
                                    <div class="row text-center">
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Movimiento Neto USD</small>
                                            <h4 class="fw-bold mb-0" id="summaryUsdNet">$0.00</h4>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Movimiento Neto PEN</small>
                                            <h4 class="fw-bold mb-0" id="summaryPenNet">S/0.00</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Reconciliación -->
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered align-middle" id="reconciliationTable" style="border-collapse: separate; border-spacing: 0;">
                            <thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th class="text-start" style="width: 25%;"><i class="bi bi-bank"></i> Cuenta Bancaria</th>
                                    <th class="text-center" style="width: 8%;"><i class="bi bi-currency-exchange"></i> Moneda</th>
                                    <th class="text-end" style="width: 12%;"><i class="bi bi-calendar-check"></i> Saldo Inicial</th>
                                    <th class="text-end" style="width: 13%;"><i class="bi bi-arrow-left-right"></i> Movimientos</th>
                                    <th class="text-end" style="width: 12%;"><i class="bi bi-calculator"></i> Saldo Esperado</th>
                                    <th class="text-end" style="width: 12%;"><i class="bi bi-cash-stack"></i> Saldo Actual</th>
                                    <th class="text-end" style="width: 12%;"><i class="bi bi-exclamation-diamond"></i> Diferencia</th>
                                    <th class="text-center" style="width: 6%;"><i class="bi bi-gear"></i></th>
                                </tr>
                            </thead>
                            <tbody id="reconciliationTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <p class="mt-2 mb-0 text-muted">Cargando datos...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tablas de Operaciones -->
    <div class="row">
        <!-- Tabla Compras -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-arrow-down-circle"></i> Compras del Día</h5>
                            <small id="subtotalCompras">Completadas: $0.00 | Pendientes: $0.00</small>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <input type="text" class="form-control form-control-sm" id="busquedaCompras" placeholder="Buscar...">
                        <select class="form-select form-select-sm" id="filtroCompras" style="width: auto;">
                            <option value="todas">Todas</option>
                            <option value="Completada">Completadas</option>
                            <option value="Pendiente">Pendientes</option>
                            <option value="En proceso">En proceso</option>
                        </select>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID OP</th>
                                    <th>Cliente</th>
                                    <th class="text-end">USD</th>
                                    <th class="text-center">TC</th>
                                    <th class="text-end">PEN</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="comprasTableBody">
                                <!-- Se llenará con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla Ventas -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-arrow-up-circle"></i> Ventas del Día</h5>
                            <small id="subtotalVentas">Completadas: $0.00 | Pendientes: $0.00</small>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <input type="text" class="form-control form-control-sm" id="busquedaVentas" placeholder="Buscar...">
                        <select class="form-select form-select-sm" id="filtroVentas" style="width: auto;">
                            <option value="todas">Todas</option>
                            <option value="Completada">Completadas</option>
                            <option value="Pendiente">Pendientes</option>
                            <option value="En proceso">En proceso</option>
                        </select>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID OP</th>
                                    <th>Cliente</th>
                                    <th class="text-end">USD</th>
                                    <th class="text-center">TC</th>
                                    <th class="text-end">PEN</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="ventasTableBody">
                                <!-- Se llenará con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Detalles de Operación -->
<div class="modal fade" id="viewOperationModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-eye"></i> Detalles de Operación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="operationDetails">
                <!-- Se llenará con JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Agregar Banco -->
<div class="modal fade" id="addBankModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-bank"></i> Agregar Cuenta Bancaria a Reconciliación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addBankForm">
                    <div class="mb-3">
                        <label class="form-label">Cuenta Bancaria de QoriCash <span class="text-danger">*</span></label>
                        <select class="form-select" id="newBankAccountSelect" required>
                            <option value="" selected disabled>Seleccionar cuenta bancaria...</option>
                            <optgroup label="USD - Dólares">
                                <option value="BCP - USD - 654321">BCP - Cuenta 654321 (USD)</option>
                                <option value="INTERBANK - USD - 456789">INTERBANK - Cuenta 456789 (USD)</option>
                                <option value="BANBIF - USD - 369852">BANBIF - Cuenta 369852 (USD)</option>
                                <option value="PICHINCHA - USD - 159796">PICHINCHA - Cuenta 159796 (USD)</option>
                            </optgroup>
                            <optgroup label="PEN - Soles">
                                <option value="BCP - PEN - 123456">BCP - Cuenta 123456 (PEN)</option>
                                <option value="INTERBANK - PEN - 987654">INTERBANK - Cuenta 987654 (PEN)</option>
                                <option value="BANBIF - PEN - 741852">BANBIF - Cuenta 741852 (PEN)</option>
                                <option value="PICHINCHA - PEN - 753951">PICHINCHA - Cuenta 753951 (PEN)</option>
                            </optgroup>
                        </select>
                        <small class="form-text text-muted">Selecciona la cuenta de QoriCash que deseas agregar a la reconciliación</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Saldo Inicial</label>
                        <input type="number" step="0.01" class="form-control" id="newBankInitialBalance" value="0.00">
                        <small class="form-text text-muted">Ingresa el saldo inicial de esta cuenta al inicio del día</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="addNewBank()">
                    <i class="bi bi-check-circle"></i> Agregar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Saldos -->
<div class="modal fade" id="editBalanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Saldos - <span id="editBankName"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editBankId">
                <input type="hidden" id="editBankCurrency">

                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Cuenta: <strong id="editBankFullName"></strong>
                </div>

                <div class="mb-3">
                    <label class="form-label">Saldo Inicial <span id="editCurrencySymbol"></span></label>
                    <input type="number" step="0.01" class="form-control" id="editInitialBalance">
                    <small class="form-text text-muted">Ingresado al inicio del día (9:00 AM)</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Saldo Actual <span id="editCurrencySymbol2"></span></label>
                    <input type="number" step="0.01" class="form-control" id="editActualBalance">
                    <small class="form-text text-muted">Saldo real al momento de revisar (6:00 PM)</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveBalanceEdits()">
                    <i class="bi bi-check-circle"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- SheetJS para generar archivos Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Función para formatear números con comas
function formatNumber(num) {
    return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// Variables globales para almacenar datos
let allCompras = [];
let allVentas = [];
let currentDate = null;
let reconciliationData = null;

// Cargar datos al iniciar
$(document).ready(function() {
    // Inicializar fecha de hoy para operaciones
    setFechaHoy();

    // Inicializar fecha de hoy para saldos bancarios
    setFechaSaldosHoy();

    // Filtros de estado
    $('#filtroCompras').on('change', function() {
        filterCompras($(this).val());
    });

    $('#filtroVentas').on('change', function() {
        filterVentas($(this).val());
    });

    // Búsquedas individuales
    $('#busquedaCompras').on('keyup', function() {
        filterCompras($('#filtroCompras').val());
    });

    $('#busquedaVentas').on('keyup', function() {
        filterVentas($('#filtroVentas').val());
    });

    // Cambio de fecha para operaciones
    $('#fechaSelector').on('change', function() {
        loadPosition($(this).val());
    });

    // Cambio de fecha para saldos bancarios
    $('#fechaSaldosSelector').on('change', function() {
        loadReconciliation($(this).val());
    });

    // Conectar a SocketIO para actualizaciones en tiempo real
    connectSocketIO();

    // Escuchar evento de actualización de posición
    if (typeof socket !== 'undefined') {
        socket.on('position_update', function(data) {
            console.log('Actualización de posición recibida');
            // Solo actualizar si estamos viendo el día de hoy (Peru timezone)
            const hoy = getPeruDate();
            const fechaActual = $('#fechaSelector').val();
            if (fechaActual === hoy) {
                loadPosition(fechaActual);
            }
        });

        // También actualizar con otros eventos de operaciones
        socket.on('nueva_operacion', function(data) {
            console.log('Nueva operación creada, actualizando posición');
            const hoy = getPeruDate();
            const fechaActual = $('#fechaSelector').val();
            if (fechaActual === hoy) {
                loadPosition(fechaActual);
            }
        });

        socket.on('operacion_actualizada', function(data) {
            console.log('Operación actualizada, actualizando posición');
            const hoy = getPeruDate();
            const fechaActual = $('#fechaSelector').val();
            if (fechaActual === hoy) {
                loadPosition(fechaActual);
            }
        });

        socket.on('operacion_completada', function(data) {
            console.log('Operación completada, actualizando posición');
            const hoy = getPeruDate();
            const fechaActual = $('#fechaSelector').val();
            if (fechaActual === hoy) {
                loadPosition(fechaActual);
            }
        });

        socket.on('operacion_cancelada', function(data) {
            console.log('Operación cancelada, actualizando posición');
            const hoy = getPeruDate();
            const fechaActual = $('#fechaSelector').val();
            if (fechaActual === hoy) {
                loadPosition(fechaActual);
            }
        });
    }
});

function setFechaHoy() {
    // Obtener fecha actual en Peru (UTC-5)
    const hoy = getPeruDate();
    $('#fechaSelector').val(hoy);
    loadPosition(hoy);
}

function setFechaAyer() {
    // Obtener fecha de ayer en Peru (UTC-5)
    const ayer = getPeruDate(1); // Restar 1 día
    $('#fechaSelector').val(ayer);
    loadPosition(ayer);
}

function setFechaSaldosHoy() {
    // Obtener fecha actual en Peru (UTC-5)
    const hoy = getPeruDate();
    $('#fechaSaldosSelector').val(hoy);
    loadReconciliation(hoy);
}

function setFechaSaldosAyer() {
    // Obtener fecha de ayer en Peru (UTC-5)
    const ayer = getPeruDate(1); // Restar 1 día
    $('#fechaSaldosSelector').val(ayer);
    loadReconciliation(ayer);
}

// Función auxiliar para obtener fecha en Peru (UTC-5)
function getPeruDate(daysToSubtract = 0) {
    // Obtener fecha/hora actual del sistema
    const now = new Date();

    // Convertir a Peru timezone usando toLocaleString
    // Esto maneja automáticamente DST y conversiones de timezone
    const peruTimeStr = now.toLocaleString('en-US', {
        timeZone: 'America/Lima',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });

    // Parse la fecha (formato: MM/DD/YYYY)
    const [month, day, year] = peruTimeStr.split('/');
    let peruDate = new Date(year, month - 1, day);

    // Restar días si es necesario
    if (daysToSubtract > 0) {
        peruDate.setDate(peruDate.getDate() - daysToSubtract);
    }

    // Formatear como YYYY-MM-DD
    const finalYear = peruDate.getFullYear();
    const finalMonth = String(peruDate.getMonth() + 1).padStart(2, '0');
    const finalDay = String(peruDate.getDate()).padStart(2, '0');
    return `${finalYear}-${finalMonth}-${finalDay}`;
}

function refreshPosition() {
    const fecha = $('#fechaSelector').val();
    loadPosition(fecha);
    showNotification('Posición actualizada', 'success');
}

function loadPosition(fecha = null) {
    const url = fecha ? `/position/api/bank_balances?fecha=${fecha}` : '/position/api/bank_balances';

    ajaxRequest(url, 'GET', null, function(response) {
        if (response.success) {
            // Almacenar datos globalmente
            allCompras = response.compras;
            allVentas = response.ventas;
            currentDate = response.fecha;

            // Actualizar subtítulo con fecha
            actualizarSubtituloFecha(response.fecha);

            // Renderizar todo
            renderPosicion(response.posicion);
            renderAlertaDesbalance(response.posicion);
            renderMetricas(response.posicion);
            renderSubtotales(response.posicion);
            renderComprasTable(response.compras);
            renderVentasTable(response.ventas);

            // Limpiar búsquedas individuales
            $('#busquedaCompras').val('');
            $('#busquedaVentas').val('');
        }
    });
}

function actualizarSubtituloFecha(fecha) {
    const hoy = getPeruDate(); // Usar fecha de Peru en lugar de UTC
    const fechaObj = new Date(fecha + 'T00:00:00');
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const fechaFormateada = fechaObj.toLocaleDateString('es-PE', opciones);

    if (fecha === hoy) {
        $('#subtituloFecha').html(`Resumen de operaciones del día - <strong>Hoy</strong> (${fechaFormateada})`);
    } else {
        $('#subtituloFecha').html(`Resumen de operaciones del día - ${fechaFormateada}`);
    }
}

function exportarExcel() {
    const fecha = $('#fechaSelector').val() || getPeruDate();

    // Calcular totales
    let totalComprasUSD = 0;
    let totalComprasPEN = 0;
    let totalVentasUSD = 0;
    let totalVentasPEN = 0;

    allCompras.forEach(op => {
        totalComprasUSD += op.amount_usd;
        totalComprasPEN += op.amount_pen;
    });

    allVentas.forEach(op => {
        totalVentasUSD += op.amount_usd;
        totalVentasPEN += op.amount_pen;
    });

    // Crear workbook de Excel
    const wb = XLSX.utils.book_new();

    // Array de arrays para construir la hoja con estructura
    const data = [];

    // TÍTULO Y FECHA
    data.push(['REPORTE DE POSICIÓN']);
    data.push([`Fecha: ${fecha}`]);
    data.push([]); // Fila vacía

    // RESUMEN
    data.push(['RESUMEN']);
    data.push(['Tipo', 'Total USD', 'Contravalor PEN']);
    data.push(['Compras', totalComprasUSD.toFixed(2), totalComprasPEN.toFixed(2)]);
    data.push(['Ventas', totalVentasUSD.toFixed(2), totalVentasPEN.toFixed(2)]);
    data.push(['Diferencia', (totalVentasUSD - totalComprasUSD).toFixed(2), (totalVentasPEN - totalComprasPEN).toFixed(2)]);
    data.push([]); // Fila vacía
    data.push([]); // Fila vacía

    // ENCABEZADOS DE LAS DOS TABLAS LADO A LADO
    data.push(['COMPRAS', '', '', '', '', '', 'VENTAS', '', '', '', '', '']);
    data.push(['ID Operación', 'Cliente', 'USD', 'TC', 'PEN', 'Estado', 'ID Operación', 'Cliente', 'USD', 'TC', 'PEN', 'Estado']);

    // DATOS DE AMBAS TABLAS (COMPRAS Y VENTAS LADO A LADO)
    const maxRows = Math.max(allCompras.length, allVentas.length);

    for (let i = 0; i < maxRows; i++) {
        const row = [];

        // Datos de Compras (columnas 0-5)
        if (i < allCompras.length) {
            const op = allCompras[i];
            row.push(op.operation_id);
            row.push(op.client_name);
            row.push(parseFloat(op.amount_usd.toFixed(2)));
            row.push(parseFloat(op.exchange_rate.toFixed(4)));
            row.push(parseFloat(op.amount_pen.toFixed(2)));
            row.push(op.status);
        } else {
            row.push('', '', '', '', '', ''); // Celdas vacías
        }

        // Datos de Ventas (columnas 6-11)
        if (i < allVentas.length) {
            const op = allVentas[i];
            row.push(op.operation_id);
            row.push(op.client_name);
            row.push(parseFloat(op.amount_usd.toFixed(2)));
            row.push(parseFloat(op.exchange_rate.toFixed(4)));
            row.push(parseFloat(op.amount_pen.toFixed(2)));
            row.push(op.status);
        } else {
            row.push('', '', '', '', '', ''); // Celdas vacías
        }

        data.push(row);
    }

    // TOTALES AL FINAL
    data.push([]); // Fila vacía
    data.push([
        'TOTAL COMPRAS',
        '',
        parseFloat(totalComprasUSD.toFixed(2)),
        '',
        parseFloat(totalComprasPEN.toFixed(2)),
        '',
        'TOTAL VENTAS',
        '',
        parseFloat(totalVentasUSD.toFixed(2)),
        '',
        parseFloat(totalVentasPEN.toFixed(2)),
        ''
    ]);

    // Crear hoja de Excel desde el array de datos
    const ws = XLSX.utils.aoa_to_sheet(data);

    // Ajustar anchos de columnas
    const colWidths = [
        { wch: 15 }, // ID Operación Compras
        { wch: 25 }, // Cliente Compras
        { wch: 12 }, // USD Compras
        { wch: 10 }, // TC Compras
        { wch: 12 }, // PEN Compras
        { wch: 12 }, // Estado Compras
        { wch: 15 }, // ID Operación Ventas
        { wch: 25 }, // Cliente Ventas
        { wch: 12 }, // USD Ventas
        { wch: 10 }, // TC Ventas
        { wch: 12 }, // PEN Ventas
        { wch: 12 }  // Estado Ventas
    ];
    ws['!cols'] = colWidths;

    // Agregar hoja al workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Posición');

    // Descargar archivo
    XLSX.writeFile(wb, `Posicion_${fecha}.xlsx`);

    showNotification('Archivo exportado correctamente', 'success');
}

function renderAlertaDesbalance(posicion) {
    const alerta = $('#alertaDesbalance');
    const mensaje = $('#mensajeDesbalance');

    if (posicion.desbalance_critico) {
        const diferencia = Math.abs(posicion.diferencia_usd);
        mensaje.text(` La posición tiene un desbalance de $${formatNumber(diferencia)}. Se requiere ${posicion.etiqueta_diferencia === 'VENDIDOS EN' ? 'comprar' : 'vender'} más para balancear.`);
        alerta.removeClass('d-none');
    } else {
        alerta.addClass('d-none');
    }
}

function renderMetricas(posicion) {
    // Badge de total de operaciones
    $('#badgeTotalOps').text(`${posicion.total_operaciones} operaciones (${posicion.cantidad_compras}C / ${posicion.cantidad_ventas}V)`);

    // Badge de TC Promedio
    const tcCompra = posicion.tc_promedio_compras;
    const tcVenta = posicion.tc_promedio_ventas;
    $('#badgeTC').text(`TC C: ${tcCompra.toFixed(4)} | V: ${tcVenta.toFixed(4)}`);
}

function renderSubtotales(posicion) {
    // Subtotales Compras
    $('#subtotalCompras').html(`Completadas: <strong>$${formatNumber(posicion.compras_completadas_usd)}</strong> | Pendientes: <strong>$${formatNumber(posicion.compras_pendientes_usd)}</strong>`);

    // Subtotales Ventas
    $('#subtotalVentas').html(`Completadas: <strong>$${formatNumber(posicion.ventas_completadas_usd)}</strong> | Pendientes: <strong>$${formatNumber(posicion.ventas_pendientes_usd)}</strong>`);
}

function filterCompras(filtro) {
    let filtered = allCompras;

    // Aplicar filtro de estado
    if (filtro !== 'todas') {
        filtered = filtered.filter(op => op.status === filtro);
    }

    // Aplicar búsqueda si existe
    const busqueda = $('#busquedaCompras').val();
    if (busqueda && busqueda.trim() !== '') {
        const terminoLower = busqueda.toLowerCase();
        filtered = filtered.filter(op => {
            return op.operation_id.toLowerCase().includes(terminoLower) ||
                   op.client_name.toLowerCase().includes(terminoLower);
        });
    }

    renderComprasTable(filtered);
}

function filterVentas(filtro) {
    let filtered = allVentas;

    // Aplicar filtro de estado
    if (filtro !== 'todas') {
        filtered = filtered.filter(op => op.status === filtro);
    }

    // Aplicar búsqueda si existe
    const busqueda = $('#busquedaVentas').val();
    if (busqueda && busqueda.trim() !== '') {
        const terminoLower = busqueda.toLowerCase();
        filtered = filtered.filter(op => {
            return op.operation_id.toLowerCase().includes(terminoLower) ||
                   op.client_name.toLowerCase().includes(terminoLower);
        });
    }

    renderVentasTable(filtered);
}

function getStatusBadge(status) {
    const badges = {
        'Completada': '<span class="badge bg-success">Completada</span>',
        'Pendiente': '<span class="badge bg-warning text-dark">Pendiente</span>',
        'En proceso': '<span class="badge bg-info">En proceso</span>',
        'Cancelado': '<span class="badge bg-danger">Cancelado</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">' + status + '</span>';
}

function renderComprasTable(compras) {
    const tbody = $('#comprasTableBody');
    tbody.empty();

    if (compras.length === 0) {
        tbody.html('<tr><td colspan="7" class="text-center text-muted py-3">No hay compras para mostrar</td></tr>');
        return;
    }

    // Ordenar: críticas primero, luego por monto descendente
    compras.sort((a, b) => {
        if (a.es_critica && !b.es_critica) return -1;
        if (!a.es_critica && b.es_critica) return 1;
        return b.amount_usd - a.amount_usd;
    });

    compras.forEach(function(op) {
        // Determinar estilo de fila si es crítica
        const rowClass = op.es_critica ? 'table-warning' : '';

        // Icono de criticidad
        const iconoCritico = op.es_critica ?
            `<i class="bi bi-exclamation-triangle-fill text-danger" title="${op.razon_critica}"></i> ` : '';

        const row = `
            <tr class="${rowClass}">
                <td class="fw-bold">${iconoCritico}${op.operation_id}</td>
                <td>${op.client_name}</td>
                <td class="text-end">$ ${formatNumber(op.amount_usd)}</td>
                <td class="text-center">${op.exchange_rate.toFixed(4)}</td>
                <td class="text-end">S/ ${formatNumber(op.amount_pen)}</td>
                <td class="text-center">${getStatusBadge(op.status)}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="verDetallesOperacion(${op.id})" title="Ver detalles">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function renderVentasTable(ventas) {
    const tbody = $('#ventasTableBody');
    tbody.empty();

    if (ventas.length === 0) {
        tbody.html('<tr><td colspan="7" class="text-center text-muted py-3">No hay ventas para mostrar</td></tr>');
        return;
    }

    // Ordenar: críticas primero, luego por monto descendente
    ventas.sort((a, b) => {
        if (a.es_critica && !b.es_critica) return -1;
        if (!a.es_critica && b.es_critica) return 1;
        return b.amount_usd - a.amount_usd;
    });

    ventas.forEach(function(op) {
        // Determinar estilo de fila si es crítica
        const rowClass = op.es_critica ? 'table-warning' : '';

        // Icono de criticidad
        const iconoCritico = op.es_critica ?
            `<i class="bi bi-exclamation-triangle-fill text-danger" title="${op.razon_critica}"></i> ` : '';

        const row = `
            <tr class="${rowClass}">
                <td class="fw-bold">${iconoCritico}${op.operation_id}</td>
                <td>${op.client_name}</td>
                <td class="text-end">$ ${formatNumber(op.amount_usd)}</td>
                <td class="text-center">${op.exchange_rate.toFixed(4)}</td>
                <td class="text-end">S/ ${formatNumber(op.amount_pen)}</td>
                <td class="text-center">${getStatusBadge(op.status)}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="verDetallesOperacion(${op.id})" title="Ver detalles">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function renderPosicion(posicion) {
    const container = $('#posicionContainer');
    container.empty();

    // Determinar el color de la diferencia según la etiqueta
    let colorDiferencia = 'secondary';
    if (posicion.etiqueta_diferencia === 'VENDIDOS EN') {
        colorDiferencia = 'success';
    } else if (posicion.etiqueta_diferencia === 'COMPRADOS EN') {
        colorDiferencia = 'danger';
    }

    // Determinar el color de la utilidad
    const colorUtilidad = posicion.utilidad_pen >= 0 ? 'success' : 'danger';

    const html = `
        <div class="row g-3">
            <!-- Columna 1: Compras -->
            <div class="col-md-4">
                <div class="card shadow-sm h-100" style="border-left: 4px solid #0d6efd;">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2" style="font-size: 0.85rem;">TOTAL COMPRAS</h6>
                        <h3 class="fw-bold text-primary mb-2">$ ${formatNumber(posicion.total_compras_usd)}</h3>
                        <hr class="my-2">
                        <small class="text-muted d-block mb-1" style="font-size: 0.75rem;">Contravalor PEN</small>
                        <h5 class="fw-bold text-secondary">S/ ${formatNumber(posicion.contravalor_compras_pen)}</h5>
                    </div>
                </div>
            </div>

            <!-- Columna 2: Ventas -->
            <div class="col-md-4">
                <div class="card shadow-sm h-100" style="border-left: 4px solid #198754;">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2" style="font-size: 0.85rem;">TOTAL VENTAS</h6>
                        <h3 class="fw-bold text-success mb-2">$ ${formatNumber(posicion.total_ventas_usd)}</h3>
                        <hr class="my-2">
                        <small class="text-muted d-block mb-1" style="font-size: 0.75rem;">Contravalor PEN</small>
                        <h5 class="fw-bold text-secondary">S/ ${formatNumber(posicion.contravalor_ventas_pen)}</h5>
                    </div>
                </div>
            </div>

            <!-- Columna 3: Diferencia (Vendidos/Comprados/Neteados) -->
            <div class="col-md-4">
                <div class="card shadow-sm h-100" style="border-left: 4px solid var(--bs-${colorDiferencia});">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2" style="font-size: 0.85rem;">${posicion.etiqueta_diferencia}</h6>
                        <h3 class="fw-bold text-${colorDiferencia} mb-2">$ ${formatNumber(Math.abs(posicion.diferencia_usd))}</h3>
                        <hr class="my-2">
                        <small class="text-muted d-block mb-1" style="font-size: 0.75rem;">UTILIDAD</small>
                        <h5 class="fw-bold text-${colorUtilidad}">S/ ${formatNumber(posicion.utilidad_pen)}</h5>
                    </div>
                </div>
            </div>
        </div>
    `;

    container.html(html);
}

// === FUNCIÓN PARA VER DETALLES DE OPERACIÓN ===
function verDetallesOperacion(operationId) {
    ajaxRequest(`/operations/api/${operationId}`, 'GET', null, function(response) {
        const op = response.operation;
        let html = buildViewHTML(op);
        $('#operationDetails').html(html);

        // Mostrar modal usando Bootstrap 5
        const modal = new bootstrap.Modal(document.getElementById('viewOperationModal'));
        modal.show();
    });
}

function buildViewHTML(op) {
    const statusBadge = getStatusBadge(op.status);
    const typeBadge = op.operation_type === 'Compra'
        ? '<span class="badge bg-success">Compra USD</span>'
        : '<span class="badge bg-primary">Venta USD</span>';

    // Función auxiliar para obtener info completa de cuenta
    const bankAccounts = op.client_bank_accounts || [];
    function getAccountInfo(accountNumber) {
        if (!accountNumber) return '<p class="text-muted mb-0">No asignada</p>';
        const account = bankAccounts.find(acc => acc.account_number === accountNumber);
        if (account) {
            return `
                <p class="mb-1"><strong>Banco:</strong> ${account.bank_name}</p>
                <p class="mb-1"><strong>Nro. Cuenta:</strong> ${account.account_number}</p>
                <p class="mb-1"><strong>Tipo:</strong> ${account.account_type}</p>
                <p class="mb-1"><strong>Moneda:</strong> ${account.currency}</p>
                <p class="mb-0"><strong>Origen:</strong> ${account.origen || '-'}</p>`;
        }
        return `<p class="mb-0"><strong>Nro. Cuenta:</strong> ${accountNumber}</p>`;
    }

    let html = `
        <div class="row mb-3">
            <div class="col-md-3"><strong>ID:</strong> ${op.operation_id}</div>
            <div class="col-md-3"><strong>Cliente:</strong> ${op.client_name || '-'}</div>
            <div class="col-md-3"><strong>Tipo:</strong> ${typeBadge}</div>
            <div class="col-md-3"><strong>Estado:</strong> ${statusBadge}</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><strong>Monto USD:</strong> $ ${parseFloat(op.amount_usd).toFixed(2)}</div>
            <div class="col-md-3"><strong>T.C.:</strong> ${parseFloat(op.exchange_rate).toFixed(4)}</div>
            <div class="col-md-3"><strong>Monto PEN:</strong> S/ ${parseFloat(op.amount_pen).toFixed(2)}</div>
            <div class="col-md-3"><strong>Creado por:</strong> ${op.user_name || '-'}</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4"><strong>Fecha Creación:</strong> ${formatDateTime(op.created_at)}</div>
            <div class="col-md-4"><strong>Enviada a Procesar:</strong> ${op.updated_at ? formatDateTime(op.updated_at) : '-'}</div>
            <div class="col-md-4"><strong>Fecha Completada:</strong> ${op.completed_at ? formatDateTime(op.completed_at) : '-'}</div>
        </div>`;

    // Cuentas Bancarias
    html += `<hr><h6><i class="bi bi-bank text-primary"></i> Cuentas Bancarias</h6>`;

    // Cuenta de Cargo/Origen
    html += `<div class="row mb-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white py-2">
                    <strong><i class="bi bi-arrow-down-circle"></i> Cuenta de Cargo / Origen</strong>
                </div>
                <div class="card-body">`;

    if (op.source_account) {
        const accountCargo = bankAccounts.find(acc => acc.account_number === op.source_account);
        html += getAccountInfo(op.source_account);
    } else {
        html += `<p class="text-muted mb-0">No asignada</p>`;
    }

    html += `</div></div></div>`;

    // Cuenta de Destino
    html += `<div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark py-2">
                    <strong><i class="bi bi-arrow-up-circle"></i> Cuenta de Destino</strong>
                </div>
                <div class="card-body">`;

    if (op.destination_account) {
        html += getAccountInfo(op.destination_account);
    } else {
        html += `<p class="text-muted mb-0">No asignada</p>`;
    }

    html += `</div></div></div></div>`;

    // Notas
    if (op.notes) {
        html += `<hr><h6>Notas</h6><p>${op.notes}</p>`;
    }

    return html;
}

function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '-';
    const date = new Date(dateTimeStr);
    const opciones = {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    };
    return date.toLocaleString('es-PE', opciones);
}

// ============================================================
// FUNCIONES DE RECONCILIACIÓN DE SALDOS BANCARIOS
// ============================================================

function loadReconciliation(fecha = null) {
    const url = fecha ? `/position/api/bank_reconciliation?fecha=${fecha}` : '/position/api/bank_reconciliation';

    ajaxRequest(url, 'GET', null, function(response) {
        if (response.success) {
            reconciliationData = response;

            // Actualizar subtítulo con fecha
            actualizarSubtituloFechaSaldos(response.fecha);

            renderReconciliationSummary(response.movements_summary);
            renderReconciliationTable(response.banks);
            // Ya no llamamos renderDiscrepancyAlert aquí - lo hace renderReconciliationTable
        }
    });
}

function refreshReconciliation() {
    const fecha = $('#fechaSaldosSelector').val();
    loadReconciliation(fecha);
    showNotification('Reconciliación actualizada', 'success');
}

function actualizarSubtituloFechaSaldos(fecha) {
    const hoy = getPeruDate();
    const fechaObj = new Date(fecha + 'T00:00:00');
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const fechaFormateada = fechaObj.toLocaleDateString('es-PE', opciones);

    if (fecha === hoy) {
        $('#subtituloFechaSaldos').html(`<strong>Hoy</strong> - ${fechaFormateada}`);
    } else {
        $('#subtituloFechaSaldos').html(`${fechaFormateada}`);
    }
}

function renderReconciliationSummary(summary) {
    $('#summaryUsdIn').text('$' + formatNumber(summary.usd.inflows));
    $('#summaryUsdOut').text('$' + formatNumber(summary.usd.outflows));
    $('#summaryPenIn').text('S/' + formatNumber(summary.pen.inflows));
    $('#summaryPenOut').text('S/' + formatNumber(summary.pen.outflows));

    // Movimiento neto con color
    const usdNetElement = $('#summaryUsdNet');
    const penNetElement = $('#summaryPenNet');

    usdNetElement.text('$' + formatNumber(summary.usd.net));
    penNetElement.text('S/' + formatNumber(summary.pen.net));

    // Colorear según positivo/negativo
    usdNetElement.removeClass('text-success text-danger').addClass(summary.usd.net >= 0 ? 'text-success' : 'text-danger');
    penNetElement.removeClass('text-success text-danger').addClass(summary.pen.net >= 0 ? 'text-success' : 'text-danger');
}

function renderReconciliationTable(banks) {
    const tbody = $('#reconciliationTableBody');
    tbody.empty();

    if (!banks || banks.length === 0) {
        tbody.html(`
            <tr>
                <td colspan="8" class="text-center">
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> No hay cuentas bancarias registradas. Haz clic en "Agregar Banco" para comenzar.
                    </div>
                </td>
            </tr>
        `);
        // Sin bancos, sin descuadre
        renderDiscrepancyAlert(0, 0);
        return;
    }

    // Lista de bancos permitidos
    const allowedBanks = ['BCP', 'INTERBANK', 'PICHINCHA', 'BANBIF'];

    // Filtrar solo los bancos permitidos
    const filteredBanks = banks.filter(bank => {
        return allowedBanks.some(allowedBank => bank.bank_name.includes(allowedBank));
    });

    // Separar por moneda
    const usdBanks = [];
    const penBanks = [];

    filteredBanks.forEach(function(bank) {
        if (bank.bank_name.includes('USD')) {
            usdBanks.push({...bank, currency: 'USD'});
        } else if (bank.bank_name.includes('PEN')) {
            penBanks.push({...bank, currency: 'PEN'});
        }
    });

    // Función auxiliar para renderizar una fila
    function renderBankRow(bank, currency, isTotal = false) {
        const symbol = currency === 'USD' ? '$' : 'S/';
        const initial = currency === 'USD' ? bank.usd.initial : bank.pen.initial;
        const movements = currency === 'USD' ? bank.usd.movements : bank.pen.movements;
        const expected = currency === 'USD' ? bank.usd.expected : bank.pen.expected;
        const actual = currency === 'USD' ? bank.usd.actual : bank.pen.actual;
        const difference = currency === 'USD' ? bank.usd.difference : bank.pen.difference;

        // Determinar color de diferencia
        const threshold = currency === 'USD' ? 10 : 30;
        const diffClass = difference === 0 ? 'text-success' : (Math.abs(difference) > threshold ? 'text-danger fw-bold' : 'text-warning');

        // Icono para diferencia
        const diffIcon = difference === 0 ? '<i class="bi bi-check-circle-fill"></i>' : '<i class="bi bi-exclamation-triangle-fill"></i>';

        const rowClass = isTotal ? 'table-active fw-bold' : '';

        if (isTotal) {
            return `
                <tr class="${rowClass}">
                    <td class="fw-bold text-primary"><i class="bi bi-calculator"></i> TOTAL ${currency}</td>
                    <td class="text-center"><span class="badge bg-${currency === 'USD' ? 'primary' : 'success'}">${currency}</span></td>
                    <td class="text-end fw-bold">${symbol}${formatNumber(initial)}</td>
                    <td class="text-end fw-bold text-info">${movements >= 0 ? '+' : ''}${symbol}${formatNumber(movements)}</td>
                    <td class="text-end fw-bold bg-light">${symbol}${formatNumber(expected)}</td>
                    <td class="text-end fw-bold">${symbol}${formatNumber(actual)}</td>
                    <td class="text-end fw-bold ${diffClass}">${diffIcon} ${symbol}${formatNumber(difference)}</td>
                    <td class="text-center">-</td>
                </tr>
            `;
        }

        return `
            <tr class="${rowClass}">
                <td><i class="bi bi-bank2"></i> ${bank.bank_name}</td>
                <td class="text-center"><span class="badge bg-${currency === 'USD' ? 'primary' : 'success'}">${currency}</span></td>
                <td class="text-end">${symbol}${formatNumber(initial)}</td>
                <td class="text-end text-info">${movements >= 0 ? '+' : ''}${symbol}${formatNumber(movements)}</td>
                <td class="text-end bg-light">${symbol}${formatNumber(expected)}</td>
                <td class="text-end">${symbol}${formatNumber(actual)}</td>
                <td class="text-end ${diffClass}">${diffIcon} ${symbol}${formatNumber(difference)}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick='openEditBalanceModal(${JSON.stringify(bank)})' title="Editar saldos">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                </td>
            </tr>
        `;
    }

    // Renderizar sección USD
    if (usdBanks.length > 0) {
        tbody.append(`
            <tr class="table-primary">
                <td colspan="8" class="fw-bold text-center">
                    <i class="bi bi-currency-dollar"></i> CUENTAS EN DÓLARES (USD)
                </td>
            </tr>
        `);

        let totalUSD = {
            usd: {
                initial: 0,
                movements: 0,
                expected: 0,
                actual: 0,
                difference: 0
            },
            pen: { initial: 0, movements: 0, expected: 0, actual: 0, difference: 0 }
        };

        usdBanks.forEach(function(bank) {
            tbody.append(renderBankRow(bank, 'USD'));
            totalUSD.usd.initial += bank.usd.initial;
            totalUSD.usd.movements += bank.usd.movements;
            totalUSD.usd.expected += bank.usd.expected;
            totalUSD.usd.actual += bank.usd.actual;
            totalUSD.usd.difference += bank.usd.difference;
        });

        tbody.append(renderBankRow(totalUSD, 'USD', true));

        // Espacio entre secciones
        tbody.append('<tr><td colspan="8" style="height: 10px; background-color: #f8f9fa;"></td></tr>');
    }

    // Renderizar sección PEN
    if (penBanks.length > 0) {
        tbody.append(`
            <tr class="table-success">
                <td colspan="8" class="fw-bold text-center">
                    <i class="bi bi-cash"></i> CUENTAS EN SOLES (PEN)
                </td>
            </tr>
        `);

        let totalPEN = {
            usd: { initial: 0, movements: 0, expected: 0, actual: 0, difference: 0 },
            pen: {
                initial: 0,
                movements: 0,
                expected: 0,
                actual: 0,
                difference: 0
            }
        };

        penBanks.forEach(function(bank) {
            tbody.append(renderBankRow(bank, 'PEN'));
            totalPEN.pen.initial += bank.pen.initial;
            totalPEN.pen.movements += bank.pen.movements;
            totalPEN.pen.expected += bank.pen.expected;
            totalPEN.pen.actual += bank.pen.actual;
            totalPEN.pen.difference += bank.pen.difference;
        });

        tbody.append(renderBankRow(totalPEN, 'PEN', true));
    }

    // Si no hay bancos después del filtrado
    if (usdBanks.length === 0 && penBanks.length === 0) {
        tbody.html(`
            <tr>
                <td colspan="8" class="text-center">
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-circle"></i> No hay cuentas de los bancos configurados (BCP, INTERBANK, PICHINCHA, BANBIF). Haz clic en "Agregar Banco" para comenzar.
                    </div>
                </td>
            </tr>
        `);
        renderDiscrepancyAlert(0, 0);
        return;
    }

    // Calcular diferencias totales SOLO de los bancos mostrados en la tabla
    const totalDifferenceUSD = usdBanks.length > 0 ? usdBanks.reduce((sum, bank) => sum + bank.usd.difference, 0) : 0;
    const totalDifferencePEN = penBanks.length > 0 ? penBanks.reduce((sum, bank) => sum + bank.pen.difference, 0) : 0;

    // Renderizar alerta de descuadre basada SOLO en lo que se muestra en la tabla
    renderDiscrepancyAlert(totalDifferenceUSD, totalDifferencePEN);
}

function renderDiscrepancyAlert(totalDifferenceUSD, totalDifferencePEN) {
    const alerta = $('#alertaDescuadre');
    const mensaje = $('#mensajeDescuadre');

    // Umbrales de descuadre crítico
    const usdThreshold = 100;
    const penThreshold = 300;

    // Verificar si hay descuadre crítico SOLO basado en datos de tabla visible
    const hasCriticalDiscrepancy = Math.abs(totalDifferenceUSD) > usdThreshold || Math.abs(totalDifferencePEN) > penThreshold;

    if (hasCriticalDiscrepancy) {
        // Mostrar alerta con las diferencias calculadas de la tabla
        mensaje.text(` Diferencia total: USD $${formatNumber(Math.abs(totalDifferenceUSD))} | PEN S/${formatNumber(Math.abs(totalDifferencePEN))}`);
        alerta.removeClass('d-none');
    } else {
        // No hay descuadre crítico, ocultar alerta
        alerta.addClass('d-none');
    }
}

function openAddBankModal() {
    $('#newBankAccountSelect').val('');
    $('#newBankInitialBalance').val('0.00');

    const modal = new bootstrap.Modal(document.getElementById('addBankModal'));
    modal.show();
}

function addNewBank() {
    const accountValue = $('#newBankAccountSelect').val();
    const initialBalance = parseFloat($('#newBankInitialBalance').val()) || 0;

    if (!accountValue) {
        showNotification('Por favor selecciona una cuenta bancaria', 'warning');
        return;
    }

    // Parse el valor seleccionado: "BCP - USD - 654321"
    const parts = accountValue.split(' - ');
    if (parts.length !== 3) {
        showNotification('Error en el formato de la cuenta seleccionada', 'danger');
        return;
    }

    const bankName = parts[0].trim();        // "BCP"
    const currency = parts[1].trim();        // "USD" o "PEN"
    const accountNumber = parts[2].trim();   // "654321"

    // Crear nombre completo para el banco: "BCP USD (654321)"
    const fullBankName = `${bankName} ${currency} (${accountNumber})`;

    // Crear el banco con saldo inicial en la moneda correspondiente
    ajaxRequest('/position/api/update_initial_balance', 'POST', {
        bank_name: fullBankName,
        currency: currency,
        amount: initialBalance
    }, function(response) {
        if (response.success) {
            showNotification('Cuenta bancaria agregada exitosamente', 'success');
            $('#addBankModal').modal('hide');
            refreshReconciliation();
        }
    });
}

function openEditBalanceModal(bank) {
    // Determinar moneda basándose en el nombre
    const currency = bank.bank_name.includes('PEN') ? 'PEN' : 'USD';
    const symbol = currency === 'USD' ? '$' : 'S/';

    // Obtener valores correctos según la moneda
    const initial = currency === 'USD' ? bank.usd.initial : bank.pen.initial;
    const actual = currency === 'USD' ? bank.usd.actual : bank.pen.actual;

    $('#editBankId').val(bank.id);
    $('#editBankName').text(bank.bank_name);
    $('#editBankFullName').text(bank.bank_name);
    $('#editBankCurrency').val(currency);
    $('#editCurrencySymbol').text(`(${symbol})`);
    $('#editCurrencySymbol2').text(`(${symbol})`);
    $('#editInitialBalance').val(initial);
    $('#editActualBalance').val(actual);

    const modal = new bootstrap.Modal(document.getElementById('editBalanceModal'));
    modal.show();
}

function saveBalanceEdits() {
    const bankName = $('#editBankName').text();
    const currency = $('#editBankCurrency').val();
    const initialBalance = parseFloat($('#editInitialBalance').val()) || 0;
    const actualBalance = parseFloat($('#editActualBalance').val()) || 0;

    // Validar que los valores no sean negativos
    if (initialBalance < 0 || actualBalance < 0) {
        showNotification('Los saldos no pueden ser negativos', 'warning');
        return;
    }

    // Actualizar saldo inicial
    ajaxRequest('/position/api/update_initial_balance', 'POST', {
        bank_name: bankName,
        currency: currency,
        amount: initialBalance
    }, function(response1) {
        if (response1.success) {
            // Actualizar saldo actual
            ajaxRequest('/position/api/update_balance', 'POST', {
                bank_name: bankName,
                currency: currency,
                amount: actualBalance
            }, function(response2) {
                if (response2.success) {
                    showNotification('Saldos actualizados exitosamente', 'success');
                    $('#editBalanceModal').modal('hide');
                    refreshReconciliation();
                }
            });
        }
    });
}
</script>
{% endblock %}
