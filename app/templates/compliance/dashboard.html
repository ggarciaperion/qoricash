{% extends "base.html" %}

{% block title %}Dashboard Middle Office - QoriCash Trading{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-shield-check"></i> Dashboard Middle Office</h2>
            <p class="text-muted">Panel de Control - Compliance y Supervisi√≥n</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
            </button>
        </div>
    </div>

    <!-- Row 1: Estad√≠sticas de Clientes -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h5><i class="bi bi-people"></i> Estad√≠sticas de Clientes</h5>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2">Total Clientes</h6>
                            <h2 class="card-title mb-0" id="totalClients">0</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-people-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2">Clientes Activos</h6>
                            <h2 class="card-title mb-0" id="activeClients">0</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2">KYC Pendientes</h6>
                            <h2 class="card-title mb-0" id="kycPending">0</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2">Docs Incompletos</h6>
                            <h2 class="card-title mb-0" id="docsIncomplete">0</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-file-earmark-x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Operaciones -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h5><i class="bi bi-arrow-left-right"></i> Operaciones del Mes</h5>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Total Operaciones</h6>
                    <h3 class="card-title mb-0 text-info" id="totalOperations">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Completadas</h6>
                    <h3 class="card-title mb-0 text-success" id="opsCompleted">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">En Proceso</h6>
                    <h3 class="card-title mb-0 text-primary" id="opsInProcess">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Pendientes</h6>
                    <h3 class="card-title mb-0 text-warning" id="opsPending">0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Compliance -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h5><i class="bi bi-exclamation-triangle"></i> Alertas y Riesgo</h5>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="bi bi-bell-fill"></i> Alertas Compliance</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Cr√≠ticas:</span>
                        <span class="badge bg-danger" id="alertsCritical">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Altas:</span>
                        <span class="badge bg-warning" id="alertsHigh">0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Medias:</span>
                        <span class="badge bg-info" id="alertsMedium">0</span>
                    </div>
                    <hr>
                    <a href="/compliance/alerts" class="btn btn-danger btn-sm w-100">
                        <i class="bi bi-eye"></i> Ver Alertas
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="bi bi-shield-exclamation"></i> Clientes de Riesgo</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>PEP:</span>
                        <span class="badge bg-warning" id="pepClients">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Listas Restrictivas:</span>
                        <span class="badge bg-danger" id="restrictiveMatches">0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Alto Riesgo:</span>
                        <span class="badge bg-danger" id="highRiskClients">0</span>
                    </div>
                    <hr>
                    <a href="/compliance/risk-profiles" class="btn btn-warning btn-sm w-100">
                        <i class="bi bi-eye"></i> Ver Perfiles
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0"><i class="bi bi-list-check"></i> Accesos R√°pidos</h6>
                </div>
                <div class="card-body">
                    <a href="/clients/list" class="btn btn-outline-primary btn-sm w-100 mb-2">
                        <i class="bi bi-people"></i> Gesti√≥n de Clientes
                    </a>
                    <a href="/compliance/kyc" class="btn btn-outline-success btn-sm w-100 mb-2">
                        <i class="bi bi-person-check"></i> Validaci√≥n KYC
                    </a>
                    <a href="/compliance/restrictive-lists" class="btn btn-outline-secondary btn-sm w-100 mb-2">
                        <i class="bi bi-shield-lock"></i> Listas Restrictivas
                    </a>
                    <a href="/compliance/audit" class="btn btn-outline-dark btn-sm w-100">
                        <i class="bi bi-file-text"></i> Auditor√≠a
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('üîµ Script del dashboard cargado en extra_js');

// ============================================
// REFRESH DASHBOARD - GLOBAL SCOPE
// ============================================
window.refreshDashboard = function() {
    console.log('üîÑ Refresh solicitado');
    window.loadDashboardData();
};

// ============================================
// CARGAR DATOS DEL DASHBOARD - GLOBAL SCOPE
// ============================================
window.loadDashboardData = function() {
    console.log('üìä [INICIO] Cargando datos del dashboard...');
    console.log('üìä [URL] Llamando a: /compliance/api/dashboard/all');

    jQuery.ajax({
        url: '/compliance/api/dashboard/all',
        method: 'GET',
        dataType: 'json',
        timeout: 30000,
        beforeSend: function() {
            console.log('üì§ [AJAX] Enviando petici√≥n...');
        },
        success: function(response) {
            console.log('‚úÖ [SUCCESS] Respuesta recibida:', response);

            if (response && response.success && response.data) {
                const d = response.data;

                console.log('üìä [DATOS] RECIBIDOS:');
                console.log('  - Total Clientes:', d.total_clients);
                console.log('  - Clientes Activos:', d.active_clients);
                console.log('  - KYC Pendientes:', d.kyc_pending);
                console.log('  - Docs Incompletos:', d.docs_incomplete);
                console.log('  - Operaciones Mes:', d.operations_month);

                // CLIENTES
                jQuery('#totalClients').text(d.total_clients || 0);
                jQuery('#activeClients').text(d.active_clients || 0);
                jQuery('#kycPending').text(d.kyc_pending || 0);
                jQuery('#docsIncomplete').text(d.docs_incomplete || 0);

                // OPERACIONES
                jQuery('#totalOperations').text(d.operations_month || 0);
                jQuery('#opsCompleted').text(d.ops_completed || 0);
                jQuery('#opsInProcess').text(d.ops_in_process || 0);
                jQuery('#opsPending').text(d.ops_pending || 0);

                // ALERTAS
                jQuery('#alertsCritical').text(d.alerts_critical || 0);
                jQuery('#alertsHigh').text(d.alerts_high || 0);
                jQuery('#alertsMedium').text(d.alerts_medium || 0);

                // RIESGO
                jQuery('#pepClients').text(d.pep_clients || 0);
                jQuery('#restrictiveMatches').text(d.restrictive_matches || 0);
                jQuery('#highRiskClients').text(d.high_risk_clients || 0);

                console.log('‚úÖ [FIN] DASHBOARD CARGADO EXITOSAMENTE');
                alert('Dashboard cargado con ' + d.total_clients + ' clientes');
            } else {
                console.error('‚ùå [ERROR] Respuesta sin success o sin data:', response);
                alert('Error: Respuesta inv√°lida del servidor');
            }
        },
        error: function(xhr, status, error) {
            console.error('‚ùå [ERROR] AJAX fall√≥:');
            console.error('  - Status HTTP:', xhr.status);
            console.error('  - Status Text:', status);
            console.error('  - Error:', error);
            console.error('  - Response Text:', xhr.responseText);

            alert('ERROR ' + xhr.status + ': ' + error + '\n\nRevisa la consola para m√°s detalles');
        },
        complete: function() {
            console.log('üèÅ [COMPLETE] Petici√≥n AJAX completada (√©xito o error)');
        }
    });
};

// ============================================
// CARGAR DATOS AL INICIAR
// ============================================
jQuery(document).ready(function($) {
    console.log('üöÄ jQuery ready - Iniciando Dashboard Middle Office...');
    console.log('üîç Verificando jQuery:', typeof $);
    console.log('üîç Verificando jQuery global:', typeof jQuery);

    // Mostrar datos de prueba primero
    console.log('üìù Mostrando datos de prueba...');
    jQuery('#totalClients').text('TEST');
    jQuery('#activeClients').text('123');

    // Esperar 1 segundo y luego cargar datos reales
    setTimeout(function() {
        console.log('‚è∞ Iniciando carga de datos reales...');
        window.loadDashboardData();
    }, 1000);
});
</script>
{% endblock %}
