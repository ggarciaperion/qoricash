{% extends "base.html" %}

{% block title %}Historial de Operaciones - QoriCash Trading{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-clock-history"></i> Historial de Operaciones</h2>
            <p class="text-muted">Registro completo de todas las operaciones</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exportDateFilterModal">
                <i class="bi bi-file-earmark-excel"></i> Descargar Excel
            </button>
        </div>
    </div>

    <!-- Tabla de Operaciones -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <table id="historyTable" class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>ID Op.</th>
                                <th>Documento</th>
                                <th>Cliente</th>
                                <th>USD</th>
                                <th>T.C.</th>
                                <th>PEN</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                {% if user.role in ['Master', 'Operador'] %}
                                <th>Usuario</th>
                                {% endif %}
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for op in operations %}
                            <tr>
                                <td><strong>{{ op.operation_id }}</strong></td>
                                <td>{{ op.client.dni if op.client else '-' }}</td>
                                <td>{{ op.client.full_name if op.client else '-' }}</td>
                                <td class="text-end">$ {{ op.amount_usd|format_currency(2) }}</td>
                                <td class="text-center">{{ "%.4f"|format(op.exchange_rate) }}</td>
                                <td class="text-end">S/ {{ op.amount_pen|format_currency(2) }}</td>
                                <td>
                                    {% if op.status == 'Pendiente' %}
                                        <span class="badge bg-warning text-dark">Pendiente</span>
                                    {% elif op.status == 'En proceso' %}
                                        <span class="badge bg-info">En Proceso</span>
                                    {% elif op.status == 'Completada' %}
                                        <span class="badge bg-success">Completada</span>
                                    {% else %}
                                        <span class="badge bg-danger">Cancelado</span>
                                    {% endif %}
                                </td>
                                <td data-order="{{ op.created_at.timestamp() if op.created_at else 0 }}">{{ op.created_at.strftime('%d/%m/%Y %H:%M') if op.created_at else '-' }}</td>
                                {% if user.role in ['Master', 'Operador'] %}
                                <td>{{ op.user.email if op.user else '-' }}</td>
                                {% endif %}
                                <td>
                                    {% if op.status == 'Completada' %}
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewOperationDetails({{ op.id }})" title="Ver detalles">
                                        <i class="bi bi-eye"></i> Ver detalles
                                    </button>
                                    {% else %}
                                    <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Filtro de Fechas para Exportar -->
    <div class="modal fade" id="exportDateFilterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-calendar-range"></i> Exportar Historial a Excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Selecciona el rango de fechas para exportar. Si no seleccionas fechas, se exportarán todas las operaciones.</p>

                    <div class="mb-3">
                        <label for="export_start_date" class="form-label">Fecha Inicio (Opcional)</label>
                        <input type="date" class="form-control" id="export_start_date">
                    </div>

                    <div class="mb-3">
                        <label for="export_end_date" class="form-label">Fecha Fin (Opcional)</label>
                        <input type="date" class="form-control" id="export_end_date">
                    </div>

                    <div class="alert alert-info small mb-0">
                        <i class="bi bi-info-circle"></i>
                        Si dejas ambos campos vacíos, se descargará el historial completo de todas las operaciones.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="downloadExcelWithDates()">
                        <i class="bi bi-download"></i> Descargar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Detalles de Operación -->
    <div class="modal fade" id="viewOperationModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-info-circle"></i> Detalles de Operación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="operationDetails">
                    <!-- Cargado dinámicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Inicializar DataTable con filtros en tiempo real
let historyTable;

$(document).ready(function() {
    // Determinar el índice de la columna Fecha según el rol
    // Si el usuario es Master u Operador, hay columna "Usuario" (índice 8 para fecha)
    // Si no, no hay columna "Usuario" (índice 7 para fecha)
    const dateColumnIndex = window.currentUserRole === 'Master' || window.currentUserRole === 'Operador' ? 7 : 7;

    historyTable = $('#historyTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"
        },
        "order": [[dateColumnIndex, "desc"]], // Ordenar por fecha descendente (más reciente primero)
        "pageLength": 25,
        "responsive": true,
        "dom": '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
        "columnDefs": [
            { "orderable": true, "targets": "_all" },
            { "orderable": false, "targets": -1 } // La columna Acciones no es ordenable
        ]
    });
});

// Función para descargar Excel con filtro de fechas
function downloadExcelWithDates() {
    const startDate = $('#export_start_date').val();
    const endDate = $('#export_end_date').val();

    // Validar que si hay fecha inicio, también haya fecha fin (y viceversa)
    if (startDate && endDate && startDate > endDate) {
        showNotification('La fecha de inicio no puede ser mayor que la fecha fin', 'warning');
        return;
    }

    // Construir URL con parámetros
    let url = '/operations/api/export_history';
    const params = [];

    if (startDate) {
        params.push(`start_date=${startDate}`);
    }

    if (endDate) {
        params.push(`end_date=${endDate}`);
    }

    if (params.length > 0) {
        url += '?' + params.join('&');
    }

    // Cerrar modal
    $('#exportDateFilterModal').modal('hide');

    // Mostrar mensaje
    if (startDate || endDate) {
        showNotification('Preparando descarga del rango seleccionado...', 'info');
    } else {
        showNotification('Preparando descarga del historial completo...', 'info');
    }

    // Descargar
    window.location.href = url;

    // Limpiar campos después de 1 segundo
    setTimeout(() => {
        $('#export_start_date').val('');
        $('#export_end_date').val('');
    }, 1000);
}

// Función legacy (por compatibilidad)
function downloadExcel() {
    window.location.href = '/operations/api/export_history';
}

// Función para ver detalles de operación (COMPLETA - idéntica a list.html)
function viewOperationDetails(operationId) {
    ajaxRequest(`/operations/api/${operationId}`, 'GET', null, function(response) {
        const op = response.operation;
        const html = buildViewHTML(op, true);
        $('#operationDetails').html(html);
        $('#viewOperationModal').modal('show');
    }, function(error) {
        showNotification('Error al cargar detalles de la operación', 'danger');
    });
}

// Construir HTML completo del modal (copiado de list.html)
function buildViewHTML(op, readonly) {
    const statusBadge = getStatusBadge(op.status);
    const typeBadge = op.operation_type === 'Compra'
        ? '<span class="badge bg-success">Compra USD</span>'
        : '<span class="badge bg-primary">Venta USD</span>';

    const bankAccounts = op.client_bank_accounts || [];

    let html = `
        <div class="row mb-3">
            <div class="col-md-3"><strong>ID:</strong> ${op.operation_id}</div>
            <div class="col-md-3"><strong>Cliente:</strong> ${op.client_name || '-'}</div>
            <div class="col-md-3"><strong>Tipo:</strong> ${typeBadge}</div>
            <div class="col-md-3"><strong>Estado:</strong> ${statusBadge}</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3"><strong>Monto USD:</strong> $ ${parseFloat(op.amount_usd).toFixed(2)}</div>
            <div class="col-md-3"><strong>T.C.:</strong> ${parseFloat(op.exchange_rate).toFixed(4)}</div>
            <div class="col-md-3"><strong>Monto PEN:</strong> S/ ${parseFloat(op.amount_pen).toFixed(2)}</div>
            <div class="col-md-3"><strong>Creado por:</strong> ${op.user_name || '-'}</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4"><strong>Fecha Creación:</strong> ${formatDateTime(op.created_at)}</div>
            <div class="col-md-4"><strong>Enviada a Procesar:</strong> ${op.updated_at ? formatDateTime(op.updated_at) : '-'}</div>
            <div class="col-md-4"><strong>Fecha Completada:</strong> ${op.completed_at ? formatDateTime(op.completed_at) : '-'}</div>
        </div>`;

    // Cuentas Bancarias
    html += `<hr><h6><i class="bi bi-bank text-primary"></i> Cuentas Bancarias</h6>`;
    html += `<div class="row mb-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white py-2">
                    <strong><i class="bi bi-arrow-down-circle"></i> Cuenta de Cargo / Origen</strong>
                </div>
                <div class="card-body">`;

    if (op.source_account) {
        const accountCargo = bankAccounts.find(acc => acc.account_number === op.source_account);
        if (accountCargo) {
            html += `
                <p class="mb-1"><strong>Banco:</strong> ${accountCargo.bank_name}</p>
                <p class="mb-1"><strong>Nro. Cuenta:</strong> ${accountCargo.account_number}</p>
                <p class="mb-1"><strong>Tipo:</strong> ${accountCargo.account_type}</p>
                <p class="mb-1"><strong>Moneda:</strong> ${accountCargo.currency}</p>
                <p class="mb-0"><strong>Origen:</strong> ${accountCargo.origen || '-'}</p>`;
        } else {
            html += `<p class="mb-0"><strong>Nro. Cuenta:</strong> ${op.source_account}</p>`;
        }
    } else {
        html += `<p class="text-muted mb-0">No asignada</p>`;
    }

    html += `</div></div></div>`;
    html += `<div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark py-2">
                    <strong><i class="bi bi-arrow-up-circle"></i> Cuenta de Destino</strong>
                </div>
                <div class="card-body">`;

    if (op.destination_account) {
        const accountDestino = bankAccounts.find(acc => acc.account_number === op.destination_account);
        if (accountDestino) {
            html += `
                <p class="mb-1"><strong>Banco:</strong> ${accountDestino.bank_name}</p>
                <p class="mb-1"><strong>Nro. Cuenta:</strong> ${accountDestino.account_number}</p>
                <p class="mb-1"><strong>Tipo:</strong> ${accountDestino.account_type}</p>
                <p class="mb-1"><strong>Moneda:</strong> ${accountDestino.currency}</p>
                <p class="mb-0"><strong>Origen:</strong> ${accountDestino.origen || '-'}</p>`;
        } else {
            html += `<p class="mb-0"><strong>Nro. Cuenta:</strong> ${op.destination_account}</p>`;
        }
    } else {
        html += `<p class="text-muted mb-0">No asignada</p>`;
    }

    html += `</div></div></div></div>`;

    // Comprobantes del operador
    if (op.operator_proofs && op.operator_proofs.length > 0) {
        html += `<hr><h6><i class="bi bi-file-earmark-check text-info"></i> Comprobantes del Operador</h6>
        <table class="table table-sm"><thead><tr><th>Comprobante</th><th>Comentarios del Operador</th><th>Atendido por</th></tr></thead><tbody>`;
        op.operator_proofs.forEach((p, index) => {
            html += `<tr>
                <td><a href="${p.comprobante_url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Descargar</a></td>`;
            if (index === 0) {
                html += `<td rowspan="${op.operator_proofs.length}">${op.operator_comments || '-'}</td>`;
                html += `<td rowspan="${op.operator_proofs.length}">`;
                if (op.status === 'Completada' && op.assigned_operator_name) {
                    html += `<i class="bi bi-person-check text-info me-1"></i><strong>${op.assigned_operator_name}</strong>`;
                } else {
                    html += '-';
                }
                html += `</td>`;
            }
            html += `</tr>`;
        });
        html += `</tbody></table>`;
    } else if (op.status === 'Completada' && op.assigned_operator_name) {
        // Si no hay comprobantes pero sí hay operador asignado, mostrar tabla simple
        html += `<hr><h6><i class="bi bi-file-earmark-check text-info"></i> Comprobantes del Operador</h6>
        <table class="table table-sm"><thead><tr><th>Comentarios del Operador</th><th>Atendido por</th></tr></thead><tbody>
        <tr>
            <td>${op.operator_comments || '-'}</td>
            <td><i class="bi bi-person-check text-info me-1"></i><strong>${op.assigned_operator_name}</strong></td>
        </tr>
        </tbody></table>`;
    }

    // Factura Electrónica
    if (op.status === 'Completada' && op.invoices && op.invoices.length > 0) {
        const acceptedInvoice = op.invoices.find(inv => inv.status === 'Aceptado');
        if (acceptedInvoice) {
            html += `<hr><h6><i class="bi bi-receipt text-success"></i> Factura Electrónica</h6>
            <div class="card border-success">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Tipo:</strong> ${acceptedInvoice.invoice_type}</p>
                            <p class="mb-1"><strong>Número:</strong> <span class="badge bg-success">${acceptedInvoice.invoice_number}</span></p>
                            <p class="mb-1"><strong>Monto:</strong> ${acceptedInvoice.moneda} ${parseFloat(acceptedInvoice.monto_total).toFixed(2)}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Estado:</strong> <span class="badge bg-success">✓ Aceptado por SUNAT</span></p>
                            <p class="mb-1"><strong>Fecha:</strong> ${formatDateTime(acceptedInvoice.created_at)}</p>
                        </div>
                    </div>
                    <div class="mt-3 d-flex gap-2">`;
            if (acceptedInvoice.nubefact_enlace_pdf) {
                html += `<a href="${acceptedInvoice.nubefact_enlace_pdf}" target="_blank" class="btn btn-success btn-sm">
                    <i class="bi bi-file-earmark-pdf"></i> Ver/Descargar PDF
                </a>`;
            }
            if (acceptedInvoice.nubefact_enlace_xml) {
                html += `<a href="${acceptedInvoice.nubefact_enlace_xml}" target="_blank" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-file-earmark-code"></i> Descargar XML
                </a>`;
            }
            html += `</div></div></div>`;
        } else {
            const pendingOrErrorInvoice = op.invoices[0];
            if (pendingOrErrorInvoice) {
                html += `<hr><h6><i class="bi bi-receipt text-warning"></i> Factura Electrónica</h6>
                <div class="alert alert-warning mb-0">
                    <strong>Estado:</strong> ${pendingOrErrorInvoice.status}<br>`;
                if (pendingOrErrorInvoice.error_message) {
                    html += `<strong>Error:</strong> ${pendingOrErrorInvoice.error_message}`;
                }
                html += `</div>`;
            }
        }
    }

    if (op.notes) {
        html += `<hr><h6>Notas</h6><p>${op.notes}</p>`;
    }

    // Historial de modificaciones
    if (op.modification_logs && op.modification_logs.length > 0) {
        html += `<hr><h6><i class="bi bi-clock-history text-secondary"></i> Historial de Modificaciones</h6>
        <table class="table table-sm table-striped"><thead><tr><th>Fecha/Hora</th><th>Usuario</th><th>Campo</th><th>Valor Anterior</th><th>Valor Nuevo</th></tr></thead><tbody>`;
        op.modification_logs.forEach(log => {
            html += `<tr>
                <td>${formatDateTime(log.fecha)}</td>
                <td>${log.usuario || '-'}</td>
                <td>${log.campo || '-'}</td>
                <td>${log.valor_anterior || '-'}</td>
                <td>${log.valor_nuevo || '-'}</td>
            </tr>`;
        });
        html += `</tbody></table>`;
    }

    return html;
}

// Helpers
function getStatusBadge(status) {
    const badges = {
        'Pendiente': '<span class="badge bg-warning text-dark">Pendiente</span>',
        'En proceso': '<span class="badge bg-info">En Proceso</span>',
        'Completada': '<span class="badge bg-success">Completada</span>',
        'Cancelado': '<span class="badge bg-danger">Cancelado</span>'
    };
    return badges[status] || status;
}

function formatDateTime(isoString) {
    if (!isoString) return '-';
    const d = new Date(isoString);
    return d.toLocaleDateString('es-PE') + ' ' + d.toLocaleTimeString('es-PE', {hour: '2-digit', minute: '2-digit'});
}
</script>
{% endblock %}
