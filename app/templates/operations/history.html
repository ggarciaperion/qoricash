{% extends "base.html" %}

{% block title %}Historial de Operaciones - QoriCash Trading{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-clock-history"></i> Historial de Operaciones</h2>
            <p class="text-muted">Registro completo de todas las operaciones</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exportDateFilterModal">
                <i class="bi bi-file-earmark-excel"></i> Descargar Excel
            </button>
        </div>
    </div>

    <!-- Tabla de Operaciones -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <table id="historyTable" class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>ID Op.</th>
                                <th>Documento</th>
                                <th>Cliente</th>
                                <th>USD</th>
                                <th>T.C.</th>
                                <th>PEN</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                {% if user.role in ['Master', 'Operador'] %}
                                <th>Usuario</th>
                                {% endif %}
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for op in operations %}
                            <tr>
                                <td><strong>{{ op.operation_id }}</strong></td>
                                <td>{{ op.client.dni if op.client else '-' }}</td>
                                <td>{{ op.client.full_name if op.client else '-' }}</td>
                                <td class="text-end">$ {{ op.amount_usd|format_currency(2) }}</td>
                                <td class="text-center">{{ "%.4f"|format(op.exchange_rate) }}</td>
                                <td class="text-end">S/ {{ op.amount_pen|format_currency(2) }}</td>
                                <td>
                                    {% if op.status == 'Pendiente' %}
                                        <span class="badge bg-warning text-dark">Pendiente</span>
                                    {% elif op.status == 'En proceso' %}
                                        <span class="badge bg-info">En Proceso</span>
                                    {% elif op.status == 'Completada' %}
                                        <span class="badge bg-success">Completada</span>
                                    {% else %}
                                        <span class="badge bg-danger">Cancelado</span>
                                    {% endif %}
                                </td>
                                <td data-order="{{ op.created_at.timestamp() if op.created_at else 0 }}">{{ op.created_at.strftime('%d/%m/%Y %H:%M') if op.created_at else '-' }}</td>
                                {% if user.role in ['Master', 'Operador'] %}
                                <td>{{ op.user.email if op.user else '-' }}</td>
                                {% endif %}
                                <td>
                                    {% if op.status == 'Completada' %}
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewOperationDetails({{ op.id }})" title="Ver detalles">
                                        <i class="bi bi-eye"></i> Ver detalles
                                    </button>
                                    {% else %}
                                    <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Filtro de Fechas para Exportar -->
    <div class="modal fade" id="exportDateFilterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-calendar-range"></i> Exportar Historial a Excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Selecciona el rango de fechas para exportar. Si no seleccionas fechas, se exportarán todas las operaciones.</p>

                    <div class="mb-3">
                        <label for="export_start_date" class="form-label">Fecha Inicio (Opcional)</label>
                        <input type="date" class="form-control" id="export_start_date">
                    </div>

                    <div class="mb-3">
                        <label for="export_end_date" class="form-label">Fecha Fin (Opcional)</label>
                        <input type="date" class="form-control" id="export_end_date">
                    </div>

                    <div class="alert alert-info small mb-0">
                        <i class="bi bi-info-circle"></i>
                        Si dejas ambos campos vacíos, se descargará el historial completo de todas las operaciones.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="downloadExcelWithDates()">
                        <i class="bi bi-download"></i> Descargar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Detalles de Operación -->
    <div class="modal fade" id="viewOperationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-info-circle"></i> Detalles de Operación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="operationDetails">
                    <!-- Cargado dinámicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Inicializar DataTable con filtros en tiempo real
let historyTable;

$(document).ready(function() {
    // Determinar el índice de la columna Fecha según el rol
    // Si el usuario es Master u Operador, hay columna "Usuario" (índice 8 para fecha)
    // Si no, no hay columna "Usuario" (índice 7 para fecha)
    const dateColumnIndex = window.currentUserRole === 'Master' || window.currentUserRole === 'Operador' ? 7 : 7;

    historyTable = $('#historyTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"
        },
        "order": [[dateColumnIndex, "desc"]], // Ordenar por fecha descendente (más reciente primero)
        "pageLength": 25,
        "responsive": true,
        "dom": '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
        "columnDefs": [
            { "orderable": true, "targets": "_all" },
            { "orderable": false, "targets": -1 } // La columna Acciones no es ordenable
        ]
    });
});

// Función para descargar Excel con filtro de fechas
function downloadExcelWithDates() {
    const startDate = $('#export_start_date').val();
    const endDate = $('#export_end_date').val();

    // Validar que si hay fecha inicio, también haya fecha fin (y viceversa)
    if (startDate && endDate && startDate > endDate) {
        showNotification('La fecha de inicio no puede ser mayor que la fecha fin', 'warning');
        return;
    }

    // Construir URL con parámetros
    let url = '/operations/api/export_history';
    const params = [];

    if (startDate) {
        params.push(`start_date=${startDate}`);
    }

    if (endDate) {
        params.push(`end_date=${endDate}`);
    }

    if (params.length > 0) {
        url += '?' + params.join('&');
    }

    // Cerrar modal
    $('#exportDateFilterModal').modal('hide');

    // Mostrar mensaje
    if (startDate || endDate) {
        showNotification('Preparando descarga del rango seleccionado...', 'info');
    } else {
        showNotification('Preparando descarga del historial completo...', 'info');
    }

    // Descargar
    window.location.href = url;

    // Limpiar campos después de 1 segundo
    setTimeout(() => {
        $('#export_start_date').val('');
        $('#export_end_date').val('');
    }, 1000);
}

// Función legacy (por compatibilidad)
function downloadExcel() {
    window.location.href = '/operations/api/export_history';
}

// Función para ver detalles de operación
function viewOperationDetails(operationId) {
    ajaxRequest(`/operations/api/${operationId}`, 'GET', null, function(response) {
        const op = response.operation;

        const html = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Información de la Operación</h6>
                    <p><strong>ID:</strong> ${op.operation_id}</p>
                    <p><strong>Tipo:</strong> <span class="badge bg-${op.operation_type === 'Compra' ? 'success' : 'primary'}">${op.operation_type}</span></p>
                    <p><strong>Estado:</strong> <span class="badge bg-success">Completada</span></p>
                    <p><strong>Usuario:</strong> ${op.user_name || '-'}</p>
                    <p><strong>Creado:</strong> ${formatDate(op.created_at)}</p>
                    ${op.completed_at ? `<p><strong>Completado:</strong> ${formatDate(op.completed_at)}</p>` : ''}
                </div>
                <div class="col-md-6">
                    <h6>Cliente</h6>
                    <p><strong>Nombre:</strong> ${op.client_name || '-'}</p>
                    <hr>
                    <h6>Montos</h6>
                    <p><strong>Monto USD:</strong> ${formatCurrency(op.amount_usd, 'USD')}</p>
                    <p><strong>Tipo de Cambio:</strong> ${parseFloat(op.exchange_rate).toLocaleString('en-US', {minimumFractionDigits: 4, maximumFractionDigits: 4})}</p>
                    <p><strong>Monto PEN:</strong> ${formatCurrency(op.amount_pen, 'PEN')}</p>
                </div>
            </div>
            ${op.source_account || op.destination_account ? `
                <hr>
                <h6>Cuentas Bancarias</h6>
                ${op.source_account ? `<p><strong>Cuenta Origen:</strong> ${op.source_account}</p>` : ''}
                ${op.destination_account ? `<p><strong>Cuenta Destino:</strong> ${op.destination_account}</p>` : ''}
            ` : ''}
            ${op.notes ? `<hr><p><strong>Notas:</strong> ${op.notes}</p>` : ''}
            ${op.payment_proof_url || op.operator_proof_url || op.operator_comments || op.assigned_operator_name ? `
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Comprobantes del Operador</h6>
                        ${op.payment_proof_url ? `<p><a href="${op.payment_proof_url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-file-earmark"></i> Ver Comprobante Cliente</a></p>` : ''}
                        ${op.operator_proof_url ? `<p><a href="${op.operator_proof_url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-file-earmark"></i> Ver Comprobante Operador</a></p>` : ''}
                        ${op.operator_comments ? `
                            <div class="mt-3">
                                <strong>Comentarios del Operador:</strong>
                                <div class="border rounded p-2 bg-light mt-1">
                                    ${op.operator_comments}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="col-md-6">
                        ${op.assigned_operator_name ? `
                            <h6>Atendido por</h6>
                            <div class="alert alert-info">
                                <i class="bi bi-person-check me-2"></i>
                                <strong>${op.assigned_operator_name}</strong>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : ''}
        `;

        $('#operationDetails').html(html);
        $('#viewOperationModal').modal('show');
    }, function(error) {
        showNotification('Error al cargar detalles de la operación', 'danger');
    });
}

// Funciones auxiliares (si no están definidas en common.js)
function formatCurrency(amount, currency = 'USD') {
    const num = parseFloat(amount);
    if (isNaN(num)) return '0.00';

    const formatted = num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

    return currency === 'USD' ? `$ ${formatted}` : `S/ ${formatted}`;
}

function formatDate(dateString) {
    if (!dateString) return '-';

    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');

    return `${day}/${month}/${year} ${hours}:${minutes}`;
}
</script>
{% endblock %}
