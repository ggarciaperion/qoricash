{% extends "base.html" %}

{% block title %}Detalle Reclamo {{ complaint.complaint_number }} - QoriCash Trading{% endblock %}

{% block head %}
<style>
    .detail-card {
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .detail-card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px 10px 0 0;
    }
    .detail-card-body {
        padding: 25px;
    }
    .info-label {
        font-weight: 600;
        color: #6c757d;
        font-size: 0.85rem;
        text-transform: uppercase;
        margin-bottom: 5px;
    }
    .info-value {
        font-size: 1rem;
        color: #212529;
        margin-bottom: 20px;
    }
    .badge-status-large {
        padding: 10px 20px;
        font-size: 1rem;
        border-radius: 20px;
    }
    .detail-text {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }
    .response-form {
        background-color: #fff3cd;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #ffc107;
    }
    .timeline-item {
        padding: 15px;
        border-left: 3px solid #007bff;
        margin-bottom: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header con botón volver -->
    <div class="row mb-4">
        <div class="col-md-6">
            <a href="{{ url_for('complaints.list_complaints') }}" class="btn btn-outline-secondary mb-3">
                <i class="bi bi-arrow-left"></i> Volver a la lista
            </a>
            <h2><i class="bi bi-file-earmark-text"></i> Detalle del Reclamo</h2>
            <p class="text-muted">{{ complaint.complaint_number }}</p>
        </div>
        <div class="col-md-6 text-end">
            {% if complaint.status == 'Pendiente' %}
                <span class="badge badge-status-large bg-warning text-dark">
                    <i class="bi bi-clock"></i> Pendiente
                </span>
            {% elif complaint.status == 'En Revisión' %}
                <span class="badge badge-status-large bg-info">
                    <i class="bi bi-eye"></i> En Revisión
                </span>
            {% elif complaint.status == 'Resuelto' %}
                <span class="badge badge-status-large bg-success">
                    <i class="bi bi-check-circle"></i> Resuelto
                </span>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Información del Reclamante -->
        <div class="col-md-6">
            <div class="card detail-card">
                <div class="detail-card-header">
                    <h5 class="mb-0"><i class="bi bi-person-circle"></i> Información del Reclamante</h5>
                </div>
                <div class="detail-card-body">
                    <div class="info-label">Tipo de Documento</div>
                    <div class="info-value">
                        <span class="badge bg-info">{{ complaint.document_type }}</span>
                    </div>

                    <div class="info-label">Número de Documento</div>
                    <div class="info-value">{{ complaint.document_number }}</div>

                    {% if complaint.document_type == 'RUC' %}
                        <div class="info-label">Razón Social</div>
                        <div class="info-value">{{ complaint.company_name }}</div>

                        <div class="info-label">Persona de Contacto</div>
                        <div class="info-value">{{ complaint.contact_person }}</div>
                    {% else %}
                        <div class="info-label">Nombre Completo</div>
                        <div class="info-value">{{ complaint.full_name }}</div>
                    {% endif %}

                    <div class="info-label">Correo Electrónico</div>
                    <div class="info-value">
                        <i class="bi bi-envelope"></i> {{ complaint.email }}
                    </div>

                    <div class="info-label">Teléfono</div>
                    <div class="info-value">
                        <i class="bi bi-telephone"></i> {{ complaint.phone }}
                    </div>

                    {% if complaint.address %}
                    <div class="info-label">Dirección</div>
                    <div class="info-value">
                        <i class="bi bi-geo-alt"></i> {{ complaint.address }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Información del Reclamo -->
        <div class="col-md-6">
            <div class="card detail-card">
                <div class="detail-card-header">
                    <h5 class="mb-0"><i class="bi bi-file-text"></i> Información del Reclamo</h5>
                </div>
                <div class="detail-card-body">
                    <div class="info-label">Número de Reclamo</div>
                    <div class="info-value">
                        <strong>{{ complaint.complaint_number }}</strong>
                    </div>

                    <div class="info-label">Tipo de Solicitud</div>
                    <div class="info-value">
                        {% if complaint.complaint_type == 'Reclamo' %}
                            <span class="badge bg-danger">Reclamo</span>
                        {% else %}
                            <span class="badge bg-warning">Queja</span>
                        {% endif %}
                    </div>

                    <div class="info-label">Fecha de Registro</div>
                    <div class="info-value">
                        {% if complaint.created_at %}
                            <i class="bi bi-calendar"></i> {{ complaint.created_at.strftime('%d/%m/%Y %H:%M') }}
                        {% else %}
                            -
                        {% endif %}
                    </div>

                    {% if complaint.resolved_at %}
                    <div class="info-label">Fecha de Resolución</div>
                    <div class="info-value">
                        <i class="bi bi-check-circle"></i> {{ complaint.resolved_at.strftime('%d/%m/%Y %H:%M') }}
                    </div>
                    {% endif %}

                    {% if complaint.resolver %}
                    <div class="info-label">Resuelto Por</div>
                    <div class="info-value">
                        <i class="bi bi-person-badge"></i> {{ complaint.resolver.username }} ({{ complaint.resolver.email }})
                    </div>
                    {% endif %}

                    <div class="info-label">Detalle del Reclamo</div>
                    <div class="detail-text">
                        {{ complaint.detail }}
                    </div>

                    {% if complaint.evidence_image_url %}
                    <div class="mt-3">
                        <a href="{{ complaint.evidence_image_url }}" target="_blank" class="btn btn-primary">
                            <i class="bi bi-image"></i> Ver Imagen de Evidencia
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Actualización (Estado, Respuesta e Imagen) -->
    <div class="row">
        <div class="col-md-12">
            <div class="card detail-card">
                <div class="card-body">
                    <h5 class="mb-3"><i class="bi bi-pencil-square"></i> Actualizar Estado y Respuesta</h5>

                    <form method="POST" action="{{ url_for('complaints.update_complaint_status', id=complaint.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Estado</label>
                                <select class="form-select" name="status" required>
                                    <option value="Pendiente" {% if complaint.status == 'Pendiente' %}selected{% endif %}>
                                        Pendiente
                                    </option>
                                    <option value="En Revisión" {% if complaint.status == 'En Revisión' %}selected{% endif %}>
                                        En Revisión
                                    </option>
                                    <option value="Resuelto" {% if complaint.status == 'Resuelto' %}selected{% endif %}>
                                        Resuelto
                                    </option>
                                </select>
                            </div>

                            <div class="col-md-12 mb-3">
                                <label class="form-label">Respuesta del Equipo</label>
                                <textarea class="form-control" name="response" rows="5"
                                          placeholder="Ingrese la respuesta al cliente...">{{ complaint.response or '' }}</textarea>
                                <small class="form-text text-muted">
                                    Esta respuesta será visible para el equipo interno. Para notificar al cliente,
                                    envíe un correo separado a {{ complaint.email }}
                                </small>
                            </div>

                            <!-- Imagen de Resolución -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label"><i class="bi bi-image"></i> Imagen de Resolución</label>

                                {% if complaint.resolution_image_url %}
                                <div class="text-center mb-3">
                                    <a href="{{ complaint.resolution_image_url }}" target="_blank">
                                        <img src="{{ complaint.resolution_image_url }}"
                                             alt="Resolución del reclamo"
                                             class="img-fluid rounded shadow-sm"
                                             style="max-height: 300px; object-fit: contain; cursor: pointer;">
                                    </a>
                                    <div class="mt-2">
                                        <small class="text-muted d-block mb-2">Click en la imagen para ver en tamaño completo</small>
                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                onclick="if(confirm('¿Eliminar esta imagen?')) document.getElementById('formRemoveImage').submit();">
                                            <i class="bi bi-trash"></i> Eliminar imagen
                                        </button>
                                    </div>
                                </div>
                                <form id="formRemoveImage" method="POST" action="{{ url_for('complaints.remove_resolution_image', id=complaint.id) }}" style="display: none;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                </form>
                                {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> Aún no se ha adjuntado una imagen de resolución
                                </div>

                                <form id="formUploadImage" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label class="form-label">Adjuntar Imagen de Resolución</label>
                                        <input type="file" class="form-control" id="resolutionImage" accept="image/*" required>
                                        <small class="form-text text-muted">
                                            Formatos permitidos: JPG, PNG. Tamaño máximo: 5MB
                                        </small>
                                    </div>
                                    <div id="imagePreview" class="mb-3" style="display: none;">
                                        <img id="previewImg" class="img-fluid rounded" style="max-height: 200px;">
                                    </div>
                                    <button type="submit" class="btn btn-primary" id="btnUpload">
                                        <i class="bi bi-cloud-upload"></i> Subir Imagen
                                    </button>
                                    <div id="uploadProgress" class="mt-2" style="display: none;">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                 role="progressbar" style="width: 100%">Subiendo...</div>
                                        </div>
                                    </div>
                                </form>

                                <script>
                                // Preview de imagen
                                document.getElementById('resolutionImage').addEventListener('change', function(e) {
                                    const file = e.target.files[0];
                                    if (file) {
                                        // Validar tipo
                                        if (!file.type.startsWith('image/')) {
                                            alert('Por favor selecciona un archivo de imagen válido');
                                            this.value = '';
                                            return;
                                        }

                                        // Validar tamaño (5MB)
                                        if (file.size > 5 * 1024 * 1024) {
                                            alert('La imagen no debe superar los 5MB');
                                            this.value = '';
                                            return;
                                        }

                                        // Mostrar preview
                                        const reader = new FileReader();
                                        reader.onload = function(e) {
                                            document.getElementById('previewImg').src = e.target.result;
                                            document.getElementById('imagePreview').style.display = 'block';
                                        };
                                        reader.readAsDataURL(file);
                                    }
                                });

                                // Upload a Cloudinary
                                document.getElementById('formUploadImage').addEventListener('submit', async function(e) {
                                    e.preventDefault();

                                    const fileInput = document.getElementById('resolutionImage');
                                    const file = fileInput.files[0];

                                    if (!file) {
                                        alert('Por favor selecciona una imagen');
                                        return;
                                    }

                                    // Mostrar progress
                                    document.getElementById('uploadProgress').style.display = 'block';
                                    document.getElementById('btnUpload').disabled = true;

                                    try {
                                        // Upload a Cloudinary
                                        const formData = new FormData();
                                        formData.append('file', file);
                                        formData.append('upload_preset', 'qoricash_complaints');
                                        formData.append('folder', 'complaints/resolutions');

                                        const cloudinaryResponse = await fetch(
                                            'https://api.cloudinary.com/v1_1/dccpxa7v5/image/upload',
                                            {
                                                method: 'POST',
                                                body: formData
                                            }
                                        );

                                        if (!cloudinaryResponse.ok) {
                                            throw new Error('Error al subir imagen a Cloudinary');
                                        }

                                        const cloudinaryData = await cloudinaryResponse.json();
                                        const imageUrl = cloudinaryData.secure_url;

                                        // Guardar URL en el backend
                                        const saveResponse = await fetch(
                                            '{{ url_for("complaints.upload_resolution_image", id=complaint.id) }}',
                                            {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'X-CSRFToken': '{{ csrf_token() }}'
                                                },
                                                body: JSON.stringify({ image_url: imageUrl })
                                            }
                                        );

                                        if (!saveResponse.ok) {
                                            throw new Error('Error al guardar la URL de la imagen');
                                        }

                                        // Recargar página
                                        window.location.reload();

                                    } catch (error) {
                                        console.error('Error:', error);
                                        alert('Error al subir la imagen: ' + error.message);
                                        document.getElementById('uploadProgress').style.display = 'none';
                                        document.getElementById('btnUpload').disabled = false;
                                    }
                                });
                                </script>
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('complaints.list_complaints') }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Cambios -->
    <div class="row">
        <div class="col-md-12">
            <div class="card detail-card">
                <div class="card-body">
                    <h5 class="mb-3"><i class="bi bi-clock-history"></i> Historial</h5>

                    <div class="timeline-item">
                        <strong><i class="bi bi-calendar-plus"></i> Creación</strong><br>
                        <small class="text-muted">
                            {{ complaint.created_at.strftime('%d/%m/%Y %H:%M') if complaint.created_at else '-' }}
                        </small>
                        <p class="mb-0 mt-2">Reclamo registrado desde el formulario web</p>
                    </div>

                    {% if complaint.updated_at and complaint.updated_at != complaint.created_at %}
                    <div class="timeline-item">
                        <strong><i class="bi bi-pencil"></i> Última Actualización</strong><br>
                        <small class="text-muted">
                            {{ complaint.updated_at.strftime('%d/%m/%Y %H:%M') }}
                        </small>
                    </div>
                    {% endif %}

                    {% if complaint.resolved_at %}
                    <div class="timeline-item" style="border-left-color: #28a745;">
                        <strong><i class="bi bi-check-circle-fill text-success"></i> Resolución</strong><br>
                        <small class="text-muted">
                            {{ complaint.resolved_at.strftime('%d/%m/%Y %H:%M') }}
                        </small>
                        {% if complaint.resolver %}
                        <p class="mb-0 mt-2">Resuelto por {{ complaint.resolver.username }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
