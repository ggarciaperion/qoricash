{% extends "base.html" %}

{% block title %}Clientes - QoriCash Trading{% endblock %}

{% block head %}
<style>
    .status-toggle {
        cursor: pointer;
    }
    .document-preview {
        max-width: 100px;
        max-height: 100px;
        cursor: pointer;
    }
    .document-section {
        border: 1px dashed #ddd;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    .form-section-title {
        font-weight: 600;
        color: #495057;
        margin-top: 20px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    .text-uppercase-input {
        text-transform: uppercase;
    }
    .bank-account-group {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f8f9fa;
    }
    .required-accounts-info {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    /* Estilos para campos bloqueados por rol Trader */
    input[readonly], select[disabled], textarea[readonly] {
        background-color: #e9ecef !important;
        cursor: not-allowed !important;
        opacity: 0.7;
    }
    input[disabled], select[disabled], textarea[disabled] {
        background-color: #e9ecef !important;
        cursor: not-allowed !important;
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="bi bi-people"></i> Gestión de Clientes</h2>
            <p class="text-muted">Administra la base de clientes</p>
        </div>
        <div class="col-md-6 text-end">
            {% if current_user.role == 'Master' %}
            <button class="btn btn-success me-2" onclick="exportClients()">
                <i class="bi bi-file-earmark-excel"></i> Exportar Excel/CSV
            </button>
            <button class="btn btn-info me-2" onclick="showBulkReassignModal()">
                <i class="bi bi-arrow-left-right"></i> Reasignar Clientes
            </button>
            {% endif %}

            {% if current_user.role in ['Master', 'Trader'] %}
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createClientModal">
                <i class="bi bi-person-plus"></i> Nuevo Cliente
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Tabla de Clientes -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <table id="clientsTable" class="table table-hover">
                        <thead>
                            <tr>
                                {% if current_user.role == 'Master' %}
                                <th><input type="checkbox" id="selectAllClients" title="Seleccionar todos"></th>
                                {% endif %}
                                <th>ID</th>
                                <th>Tipo Doc</th>
                                <th>Documento</th>
                                <th>Nombre Completo</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                {% if current_user.role in ['Master', 'Operador'] %}
                                <th>Usuario</th>
                                {% endif %}
                                <th>Fecha Registro</th>
                                <th>Estado</th>
                                <th>Operaciones</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in clients %}
                            <tr data-client-id="{{ c.id }}">
                                {% if current_user.role == 'Master' %}
                                <td><input type="checkbox" class="client-checkbox" value="{{ c.id }}"></td>
                                {% endif %}
                                <td>{{ c.id }}</td>
                                <td>
                                    <span class="badge bg-info">{{ c.document_type }}</span>
                                </td>
                                <td>{{ c.dni }}</td>
                                <td><strong>{{ c.full_name or '-' }}</strong></td>
                                <td>{{ c.email }}</td>
                                <td>{{ c.phone or '-' }}</td>
                                {% if current_user.role in ['Master', 'Operador'] %}
                                <td>
                                    {% if c.creator %}
                                        <span class="badge bg-secondary" title="{{ c.creator.role }}">
                                            <i class="bi bi-envelope"></i> {{ c.creator.email }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                <td>
                                    {% if c.created_at %}
                                        <small>{{ c.created_at.strftime('%d/%m/%Y') }}</small><br>
                                        <small class="text-muted">{{ c.created_at.strftime('%H:%M') }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if c.status == 'Activo' %}
                                        <span class="badge bg-success status-badge">Activo</span>
                                    {% else %}
                                        <span class="badge bg-secondary status-badge">Inactivo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ c.get_total_operations() }}</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <!-- Ver -->
                                        <button class="btn btn-info" onclick="viewClient({{ c.id }})" title="Ver">
                                            <i class="bi bi-eye"></i>
                                        </button>

                                        <!-- Editar -->
                                        {% if current_user.role in ['Master', 'Trader', 'Operador'] %}
                                        <button class="btn btn-warning" onclick="editClient({{ c.id }})" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        {% endif %}

                                        <!-- Reasignar (solo Master) -->
                                        {% if current_user.role == 'Master' %}
                                        <button class="btn btn-primary" onclick="showReassignModal({{ c.id }})" title="Reasignar a otro trader">
                                            <i class="bi bi-arrow-left-right"></i>
                                        </button>
                                        {% endif %}

                                        <!-- Cambiar Estado (Master y Operador) -->
                                        {% if current_user.role in ['Master', 'Operador'] %}
                                        <button class="btn btn-{% if c.status == 'Activo' %}secondary{% else %}success{% endif %}"
                                                onclick="toggleClientStatus({{ c.id }}, '{{ c.status }}')"
                                                title="{% if c.status == 'Activo' %}Desactivar{% else %}Activar{% endif %}">
                                            <i class="bi bi-{% if c.status == 'Activo' %}x-circle{% else %}check-circle{% endif %}"></i>
                                        </button>
                                        {% endif %}

                                        <!-- Eliminar (solo Master) -->
                                        {% if current_user.role == 'Master' %}
                                        <button class="btn btn-danger" onclick="deleteClient({{ c.id }})" title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear/Editar Cliente -->
<div class="modal fade" id="createClientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="bi bi-person-plus"></i> Nuevo Cliente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="clientForm" enctype="multipart/form-data">
                    <input type="hidden" id="clientId" name="client_id">

                    <!-- Tipo de Documento (OBLIGATORIO Y PRIMERO) -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Documento <span class="text-danger">*</span></label>
                            <select class="form-select" id="documentType" name="document_type" required onchange="changeDocumentType()">
                                <option value="">Seleccionar...</option>
                                <option value="DNI">DNI</option>
                                <option value="CE">CE (Carnet de Extranjería)</option>
                                <option value="RUC">RUC</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Número de Documento <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="dni" name="dni" required>
                            <small class="form-text text-muted" id="dniHelp">Ingrese el número de documento</small>
                        </div>
                    </div>

                    <!-- Campos para DNI/CE -->
                    <div id="dniCeFields" style="display: none;">
                        <div class="form-section-title">Información Personal</div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Apellido Paterno <span class="text-danger">*</span></label>
                                <input type="text" class="form-control text-uppercase-input" id="apellidoPaterno" name="apellido_paterno">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Apellido Materno <span class="text-danger">*</span></label>
                                <input type="text" class="form-control text-uppercase-input" id="apellidoMaterno" name="apellido_materno">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Nombres <span class="text-danger">*</span></label>
                                <input type="text" class="form-control text-uppercase-input" id="nombres" name="nombres">
                            </div>
                        </div>

                        <div class="form-section-title">Documentos de Identidad</div>
                        <div class="document-section">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">DNI/CE Anverso (Frontal)</label>
                                    <input type="file" class="form-control" id="dniFront" name="dni_front" accept="image/*,.pdf">
                                    <div id="dniFrontPreview" class="mt-2"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">DNI/CE Reverso (Posterior)</label>
                                    <input type="file" class="form-control" id="dniBack" name="dni_back" accept="image/*,.pdf">
                                    <div id="dniBackPreview" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos para RUC -->
                    <div id="rucFields" style="display: none;">
                        <div class="form-section-title">Información de la Empresa</div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Razón Social <span class="text-danger">*</span></label>
                                <input type="text" class="form-control text-uppercase-input" id="razonSocial" name="razon_social">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Persona de Contacto</label>
                                <input type="text" class="form-control text-uppercase-input" id="personaContacto" name="persona_contacto">
                            </div>
                        </div>

                        <div class="form-section-title">Documentos del Representante Legal</div>
                        <div class="document-section">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">DNI/CE Representante - Anverso</label>
                                    <input type="file" class="form-control" id="dniRepFront" name="dni_representante_front" accept="image/*,.pdf">
                                    <div id="dniRepFrontPreview" class="mt-2"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">DNI/CE Representante - Reverso</label>
                                    <input type="file" class="form-control" id="dniRepBack" name="dni_representante_back" accept="image/*,.pdf">
                                    <div id="dniRepBackPreview" class="mt-2"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <label class="form-label">Ficha RUC</label>
                                    <input type="file" class="form-control" id="fichaRuc" name="ficha_ruc" accept="image/*,.pdf">
                                    <div id="fichaRucPreview" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Validación OC (Solo para Master y Operador) -->
                    <div id="validationOcSection" style="display: none;">
                        <div class="form-section-title">
                            <i class="bi bi-shield-check"></i> Validación Oficial de Cumplimiento (OC)
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Documento de análisis:</strong> Adjunta el informe de validación del Oficial de Cumplimiento sobre lavado de activos, PEP y procesos abiertos.
                        </div>

                        <!-- Estado de validación -->
                        <div id="validationOcStatus" class="mb-3"></div>

                        <!-- Formulario de subida -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Documento de Validación OC</label>
                                <input type="file" class="form-control" id="validationOcFile" name="validation_oc_file" accept=".pdf,.doc,.docx,image/*">
                                <small class="form-text text-muted">Formatos permitidos: PDF, Word, Imágenes</small>
                                <div id="validationOcPreview" class="mt-2"></div>
                            </div>
                        </div>

                        <!-- Botón para subir documento -->
                        <div class="text-center mb-3">
                            <button type="button" class="btn btn-success" id="uploadValidationOcBtn" onclick="uploadValidationOc()" style="display: none;">
                                <i class="bi bi-upload"></i> Subir Documento de Validación
                            </button>
                        </div>
                    </div>

                    <!-- Información de Contacto (común para todos) -->
                    <div class="form-section-title">Información de Contacto</div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Teléfono(s)</label>
                            <input type="text" class="form-control" id="phone" name="phone" placeholder="987654321 o 987654321;912345678">
                            <small class="form-text text-muted">Solo números. Para varios contactos, separa con punto y coma (;)</small>
                        </div>
                    </div>

                    <!-- Dirección -->
                    <div class="form-section-title">Dirección</div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="direccion" name="direccion" placeholder="Calle, Av., Jr., etc.">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Distrito</label>
                            <input type="text" class="form-control" id="distrito" name="distrito">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Provincia</label>
                            <input type="text" class="form-control" id="provincia" name="provincia">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Departamento</label>
                            <input type="text" class="form-control" id="departamento" name="departamento">
                        </div>
                    </div>

                    <!-- Información Bancaria -->
                    <div class="form-section-title">Información Bancaria</div>
                    <div class="required-accounts-info">
                        <i class="bi bi-info-circle"></i> <strong>Importante:</strong> Debes registrar al menos dos cuentas bancarias (una en Soles y otra en Dólares). Máximo 6 cuentas.
                        <br><small class="text-muted">✅ Puedes tener múltiples cuentas del mismo banco en la misma moneda, siempre que los números de cuenta sean diferentes.</small>
                    </div>

                    <!-- Contenedor dinámico de cuentas bancarias -->
                    <div id="bankAccountsContainer"></div>

                    <!-- Botón para agregar más cuentas -->
                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="addBankAccountBtn" onclick="addBankAccount()">
                            <i class="bi bi-plus-circle"></i> Agregar Cuenta Bancaria
                        </button>
                        <small class="d-block text-muted mt-2">
                            <span id="accountCount">0</span> de 6 cuentas registradas
                        </small>
                    </div>

                    <div id="accountsValidationMessage" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i> Debes registrar al menos una cuenta en Soles (S/) y una en Dólares ($).
                    </div>

                    <div id="duplicateAccountsMessage" class="alert alert-danger" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i> Tienes una cuenta duplicada exacta (mismo banco, tipo, número y moneda). Por favor, verifica los datos.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveClient()" id="btnSaveClient">
                    <i class="bi bi-save"></i> Guardar Cliente
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Cliente -->
<div class="modal fade" id="viewClientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-eye"></i> Detalles del Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewClientBody">
                <!-- Se llenará dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reasignar Cliente Individual -->
<div class="modal fade" id="reassignClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-left-right"></i> Reasignar Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reassignClientId">
                <div class="mb-3">
                    <label class="form-label">Cliente:</label>
                    <p id="reassignClientName" class="fw-bold"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Trader Actual:</label>
                    <p id="reassignCurrentTrader" class="text-muted"></p>
                </div>
                <div class="mb-3">
                    <label for="reassignNewTrader" class="form-label">Nuevo Trader:</label>
                    <select class="form-select" id="reassignNewTrader" required>
                        <option value="">Seleccione un trader...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmReassignClient()">
                    <i class="bi bi-check"></i> Reasignar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reasignación Masiva -->
<div class="modal fade" id="bulkReassignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-left-right"></i> Reasignación Masiva de Clientes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Puede seleccionar clientes individualmente con los checkboxes o reasignar todos los clientes de un trader específico.
                </div>

                <!-- Opción 1: Reasignar seleccionados -->
                <div class="mb-4">
                    <h6>Opción 1: Reasignar Clientes Seleccionados</h6>
                    <p id="bulkSelectedCount" class="text-muted">No hay clientes seleccionados</p>
                    <div class="mb-3">
                        <label for="bulkNewTrader" class="form-label">Nuevo Trader:</label>
                        <select class="form-select" id="bulkNewTrader">
                            <option value="">Seleccione un trader...</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="confirmBulkReassignSelected()">
                        <i class="bi bi-check"></i> Reasignar Seleccionados
                    </button>
                </div>

                <hr>

                <!-- Opción 2: Reasignar todos de un trader -->
                <div class="mb-4">
                    <h6>Opción 2: Reasignar Todos los Clientes de un Trader</h6>
                    <div class="mb-3">
                        <label for="bulkSourceTrader" class="form-label">Trader Origen:</label>
                        <select class="form-select" id="bulkSourceTrader">
                            <option value="">Seleccione trader origen...</option>
                        </select>
                        <small class="text-muted" id="bulkSourceTraderInfo"></small>
                    </div>
                    <div class="mb-3">
                        <label for="bulkTargetTrader" class="form-label">Trader Destino:</label>
                        <select class="form-select" id="bulkTargetTrader">
                            <option value="">Seleccione trader destino...</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-warning" onclick="confirmBulkReassignFromTrader()">
                        <i class="bi bi-check"></i> Reasignar Todos
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Socket.IO para actualizaciones en tiempo real -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js" crossorigin="anonymous"></script>

<script>
    // Pasar el rol del usuario actual al JavaScript para restricciones
    currentUserRole = "{{ current_user.role }}";
</script>
<script src="{{ url_for('static', filename='js/clients.js') }}"></script>
<script>
    // Inicializar DataTable al cargar la página
    $(document).ready(function() {
        $('#clientsTable').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
            },
            order: [[0, 'desc']],
            pageLength: 25,
            responsive: true
        });
    });

    // Asegurar que al abrir el modal el foco se coloque en el primer input
    // Y aplicar restricciones si es necesario
    // Nota: createClientModal ya está declarado en clients.js
    const modalElement = document.getElementById('createClientModal');
    if (modalElement) {
        modalElement.addEventListener('shown.bs.modal', function (event) {
            console.log('Modal shown - aplicando restricciones si es necesario');
            console.log('Current user role:', currentUserRole);

            // Aplicar restricciones de rol después de que el modal esté completamente visible
            // Usar setTimeout para asegurar que todos los campos dinámicos (cuentas bancarias) estén cargados
            if (currentUserRole && typeof applyRoleRestrictions === 'function') {
                setTimeout(function() {
                    applyRoleRestrictions(currentUserRole);
                }, 100);
            }

            // Foco en primer input (solo si no es Trader o es un campo editable)
            if (currentUserRole !== 'Trader') {
                var firstInput = modalElement.querySelector('input, select, textarea, [autofocus]');
                if (firstInput) {
                    try { firstInput.focus(); } catch(e) { /* ignore */ }
                }
            }
        });

        // Limpiar restricciones cuando el modal se cierra
        modalElement.addEventListener('hidden.bs.modal', function (event) {
            // Eliminar nota de restricción
            const restrictionNote = document.getElementById('traderRestrictionNote');
            if (restrictionNote) {
                restrictionNote.remove();
            }

            // Habilitar todos los campos nuevamente (excepto documentType y dni que siempre están disabled al editar)
            const form = document.getElementById('clientForm');
            if (form) {
                const allFields = form.querySelectorAll('input, select, textarea');
                allFields.forEach(field => {
                    // No reactivar documentType y dni ya que siempre deben estar disabled al editar
                    if (field.id === 'documentType' || field.id === 'dni') {
                        return;
                    }
                    field.disabled = false;
                    field.readOnly = false;
                    field.classList.remove('bg-light');
                    field.style.backgroundColor = '';
                    field.style.cursor = '';
                    field.style.opacity = '';
                });
            }
        });
    }

    // Helper para exportar (usando endpoint)
    function exportClients() {
        window.location = "{{ url_for('clients.export_csv') }}";
    }
</script>
{% endblock %}